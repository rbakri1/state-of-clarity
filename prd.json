{
  "project": "State of Clarity",
  "branchName": "ralph/question-classification-and-parallel-execution",
  "description": "Add question classification system and parallel agent execution to reduce brief generation time from 60s to 40s while routing questions to specialist agent personas",
  "userStories": [
    {
      "id": "US-001",
      "title": "Define classification taxonomy types",
      "description": "As a developer, I need clear TypeScript types defining all possible classification values so the codebase is type-safe.",
      "acceptanceCriteria": [
        "Create /lib/types/classification.ts",
        "Define Domain type: 'economics' | 'healthcare' | 'climate' | 'education' | 'defense' | 'immigration' | 'housing' | 'justice' | 'technology' | 'governance' | 'other'",
        "Define ControversyLevel type: 'low' | 'medium' | 'high'",
        "Define QuestionType type: 'factual' | 'analytical' | 'opinion' | 'comparative'",
        "Define TemporalScope type: 'historical' | 'current' | 'future' | 'timeless'",
        "Define QuestionClassification interface combining all above",
        "Export all types",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create question classifier service",
      "description": "As a developer, I need a service that takes a question string and returns structured classification data so that downstream agents can make informed decisions.",
      "acceptanceCriteria": [
        "Create /lib/agents/question-classifier.ts",
        "Function signature: classifyQuestion(question: string): Promise<QuestionClassification>",
        "Returns object with: domain, controversyLevel, questionType, temporalScope",
        "Uses Claude Haiku for cost efficiency",
        "Prompt instructs Claude to return JSON matching QuestionClassification type",
        "Prompt includes examples for each domain category",
        "Handles edge cases: questions spanning multiple domains pick primary",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Test classifier with sample questions",
      "description": "As a developer, I need to verify the classifier works correctly across different question types.",
      "acceptanceCriteria": [
        "Test domain classification with 5 diverse questions",
        "Test controversy: 'Should UK adopt 4-day week?' (medium) vs 'Should UK rejoin EU?' (high) vs 'What is GDP?' (low)",
        "Test question type: 'What is inflation?' (factual) vs 'Why did inflation rise?' (analytical) vs 'Should we raise rates?' (opinion)",
        "Test temporal: 'What caused 2008 crisis?' (historical) vs 'Current inflation rate?' (current) vs 'Will AI replace jobs?' (future)",
        "All tests pass with expected classifications",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Add classification column to briefs table",
      "description": "As a developer, I need classification data persisted with the brief so we can analyze patterns and improve the system.",
      "acceptanceCriteria": [
        "Add classification JSONB column to briefs table (nullable for existing briefs)",
        "Generate and run migration successfully",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Create specialist agent persona mapping",
      "description": "As a developer, I need a mapping from domain classification to specialist agent personas so routing works.",
      "acceptanceCriteria": [
        "Create /lib/agents/specialist-personas.ts",
        "Define 10 specialist personas with domain-specific system prompts",
        "Each persona includes: name, domain expertise, key considerations, authoritative sources to prefer",
        "Export getSpecialistPersona(domain: Domain): SpecialistPersona function",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Add agent_execution_logs table to database",
      "description": "As a developer, I need a database table to store agent execution logs for observability and optimization.",
      "acceptanceCriteria": [
        "Add agent_execution_logs table with columns: id, brief_id, agent_name, started_at, completed_at, duration_ms, status, error_message, metadata (JSONB)",
        "Foreign key to briefs table",
        "Index on brief_id and started_at",
        "Generate and run migration successfully",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Define summary agent reading level prompts",
      "description": "As a developer, I need distinct prompts for each reading level so summaries are appropriately targeted.",
      "acceptanceCriteria": [
        "Create /lib/agents/summary-prompts.ts",
        "Child prompt: 100-150 words, simple vocabulary, analogies, no jargon",
        "Teen prompt: 200-250 words, accessible but more detail, define key terms",
        "Undergrad prompt: 350-400 words, academic vocabulary OK, cite key sources",
        "Postdoc prompt: 450-500 words, technical depth, assume domain knowledge, nuanced trade-offs",
        "Each prompt includes example output for reference",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Add retry logic wrapper for agent execution",
      "description": "As a developer, I need agents to retry on failure so transient API errors don't break generation.",
      "acceptanceCriteria": [
        "Create /lib/agents/retry-wrapper.ts",
        "Wrap each agent execution in retry logic",
        "Retry up to 3 times with exponential backoff (1s, 2s, 4s)",
        "Log each retry attempt with error details",
        "After 3 failures, throw error and fail brief generation",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Add agent execution logging utility",
      "description": "As a developer, I need to log agent execution times and status so we can monitor performance.",
      "acceptanceCriteria": [
        "Create /lib/agents/execution-logger.ts",
        "Log start time, end time, and duration for each agent",
        "Log agent name, input size (token count estimate), output size",
        "Log whether execution was parallel or sequential",
        "Store logs in agent_execution_logs table (async, non-blocking)",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Create LangGraph orchestrator with parallel execution",
      "description": "As a developer, I need the LangGraph orchestrator to support parallel node execution so multiple agents can run simultaneously.",
      "acceptanceCriteria": [
        "Create /lib/agents/langgraph-orchestrator.ts",
        "Use LangGraph's parallel branch feature for concurrent execution",
        "Pipeline: Research → Classification → [Structure || Narrative] → Reconciliation → [4x Summary] → Clarity Scoring",
        "Parallel branches merge before next sequential step",
        "Integrate retry wrapper and execution logger",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Implement parallel Structure and Narrative execution",
      "description": "As a developer, I need Structure and Narrative agents to run concurrently so we save ~15 seconds of generation time.",
      "acceptanceCriteria": [
        "Structure agent and Narrative agent start simultaneously after Research completes",
        "Both agents receive same research sources as input",
        "Both agents use specialist persona from classification",
        "Execution time for both is ~25s (previously 15s + 25s = 40s sequential)",
        "Measure and log parallel execution time",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Create reconciliation agent",
      "description": "As a developer, I need a reconciliation agent that compares Structure and Narrative outputs to identify and fix inconsistencies.",
      "acceptanceCriteria": [
        "Create /lib/agents/reconciliation-agent.ts",
        "Agent receives Structure output + Narrative output",
        "Checks: Do all factors in Narrative appear in Structure table? Do all policies mentioned align?",
        "If inconsistencies found: Agent suggests minimal fixes to Narrative (Structure is source of truth)",
        "Returns reconciled Narrative + list of changes made",
        "Completes in <10 seconds",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Implement parallel Summary agent execution",
      "description": "As a developer, I need 4 Summary agents (child/teen/undergrad/postdoc) to run concurrently so we save ~30 seconds.",
      "acceptanceCriteria": [
        "Create 4 parallel Summary agent instances in orchestrator",
        "All 4 start simultaneously after Structure is complete",
        "Each agent receives Structure output + its reading level prompt",
        "Each agent generates summary for its reading level",
        "All 4 complete in ~15 seconds total (previously 4 × 10s = 40s sequential)",
        "Results collected into single summaries object",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Integrate classifier into brief generation pipeline",
      "description": "As a developer, I need the classifier to run as the first step in brief generation so all downstream agents have access to classification data.",
      "acceptanceCriteria": [
        "Classification runs after research agent in pipeline",
        "Classification result stored in agent state and passed to all subsequent agents",
        "Classification adds <2 seconds to total generation time",
        "Classification result logged for observability",
        "Classification data saved to brief record when brief is created",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Create SSE endpoint for real-time agent status",
      "description": "As a developer, I need to stream agent status updates to the UI so the swarm visualization reflects actual progress.",
      "acceptanceCriteria": [
        "Create /app/api/briefs/generate/route.ts with Server-Sent Events",
        "Stream events: agent_started, agent_completed, stage_changed, brief_ready",
        "Each event includes: agent_name, timestamp, stage_name",
        "Connection closes when brief is complete",
        "Handle client disconnection gracefully",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Create swarm visualization component",
      "description": "As a user, I want to see an animated visualization of agents working simultaneously so I understand what's happening during generation.",
      "acceptanceCriteria": [
        "Create /app/components/SwarmVisualization.tsx",
        "Show 6 agent avatars/icons in a swarm arrangement",
        "Agents pulse/animate when active, dim when waiting, checkmark when complete",
        "Show which agents are running in parallel",
        "Display current step name: Researching..., Generating structure and narrative..., Writing summaries...",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Integrate swarm visualization into generation UI",
      "description": "As a user, I want to see the swarm visualization while my brief is being generated.",
      "acceptanceCriteria": [
        "Swarm visualization appears after user submits question",
        "Component subscribes to SSE endpoint and receives real-time status updates",
        "Updates which agents are active based on SSE events",
        "Transitions smoothly between pipeline stages",
        "Disappears when brief is ready, replaced by brief content",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Validate parallel execution performance improvement",
      "description": "As a developer, I need to validate that parallel execution actually reduces generation time.",
      "acceptanceCriteria": [
        "Run 5 test briefs with parallel execution enabled",
        "Measure p50 and p95 generation times from agent_execution_logs",
        "Target: total generation time <45 seconds (p95)",
        "Document results in console output",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    }
  ]
}
