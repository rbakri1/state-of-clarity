{
  "project": "State of Clarity",
  "branchName": "ralph/error-handling",
  "description": "Error Handling - Sentry integration, error boundaries, retry logic, friendly messages, skeleton states, and graceful degradation",
  "userStories": [
    {
      "id": "US-001",
      "title": "Install and configure Sentry",
      "description": "As a developer, I need Sentry configured to track errors.",
      "acceptanceCriteria": [
        "Install @sentry/nextjs package",
        "Create sentry.client.config.ts, sentry.server.config.ts, sentry.edge.config.ts",
        "Add SENTRY_DSN to .env.example",
        "Configure source maps upload in next.config.mjs",
        "Add withSentryConfig wrapper to next.config.mjs",
        "Document Sentry setup in SETUP.md",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create error boundary wrapper component",
      "description": "As a developer, I need a reusable error boundary for React components.",
      "acceptanceCriteria": [
        "Create /app/components/ErrorBoundary.tsx",
        "Catch React errors and report to Sentry",
        "Display fallback UI with friendly message",
        "Include 'Try again' button that resets error state",
        "Include 'Show details' toggle for technical info",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Wrap main layout with error boundary",
      "description": "As a user, I want the app to recover gracefully from crashes.",
      "acceptanceCriteria": [
        "Wrap app/layout.tsx children with ErrorBoundary",
        "Ensure global-error.tsx handles root-level errors",
        "Verify error shows friendly UI not white screen",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Create standardized API error response format",
      "description": "As a developer, I need consistent error responses from all APIs.",
      "acceptanceCriteria": [
        "Create /lib/errors/api-error.ts with ApiError class",
        "ApiError has: statusCode, message, code, details",
        "Create formatErrorResponse helper function",
        "Define error codes: UNAUTHORIZED, NOT_FOUND, VALIDATION_ERROR, RATE_LIMITED, SERVICE_UNAVAILABLE",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Create API error handling wrapper",
      "description": "As a developer, I need centralized error handling for API routes.",
      "acceptanceCriteria": [
        "Create /lib/errors/with-error-handling.ts",
        "Higher-order function wrapping API route handlers",
        "Catch errors and return formatted JSON response",
        "Log errors to Sentry with context",
        "Return appropriate HTTP status codes",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Apply error handling to key API routes",
      "description": "As a developer, I need API routes to use consistent error handling.",
      "acceptanceCriteria": [
        "Update /app/api/briefs/[id]/vote/route.ts to use withErrorHandling",
        "Update /app/api/profile/route.ts to use withErrorHandling",
        "Update /app/api/questions/suggest/route.ts to use withErrorHandling",
        "Verify errors return formatted JSON",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Create retry utility with exponential backoff",
      "description": "As a developer, I need a utility for retrying failed requests.",
      "acceptanceCriteria": [
        "Create /lib/utils/retry.ts",
        "Function retryWithBackoff(fn, options) with maxRetries, initialDelay, maxDelay",
        "Exponential backoff: delay doubles each retry",
        "Add jitter to prevent thundering herd",
        "Throw after all retries exhausted",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Create fetch wrapper with auto-retry",
      "description": "As a developer, I need a fetch wrapper that handles retries.",
      "acceptanceCriteria": [
        "Create /lib/utils/fetcher.ts",
        "Function fetchWithRetry(url, options) using retryWithBackoff",
        "Auto-retry on network errors and 5xx responses",
        "Don't retry on 4xx responses",
        "Log retry attempts",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Create user-friendly error message component",
      "description": "As a user, I want to see helpful error messages.",
      "acceptanceCriteria": [
        "Create /app/components/ErrorMessage.tsx",
        "Props: title, message, details (optional), onRetry (optional)",
        "Display friendly icon and message",
        "Collapsible 'Show technical details' section",
        "'Try again' button if onRetry provided",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Create error message mapping",
      "description": "As a developer, I need to map error codes to friendly messages.",
      "acceptanceCriteria": [
        "Create /lib/errors/error-messages.ts",
        "Map error codes to { title, message } objects",
        "Include: UNAUTHORIZED, NOT_FOUND, RATE_LIMITED, SERVICE_UNAVAILABLE, NETWORK_ERROR",
        "Provide default fallback for unknown errors",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Create loading skeleton components",
      "description": "As a user, I want to see placeholders while content loads.",
      "acceptanceCriteria": [
        "Create /app/components/Skeleton.tsx",
        "Variants: text, paragraph, card, avatar, button",
        "Animate with subtle pulse effect",
        "Accept className for custom sizing",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 11,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Add skeleton loading state to brief page",
      "description": "As a user, I want to see loading placeholders on brief page.",
      "acceptanceCriteria": [
        "Create /app/brief/[id]/loading.tsx",
        "Skeleton for: header, summary, structured data, narrative",
        "Match actual page layout structure",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 12,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Add skeleton loading state to homepage",
      "description": "As a user, I want to see loading placeholders on homepage.",
      "acceptanceCriteria": [
        "Create /app/loading.tsx",
        "Skeleton for: topic grid, featured briefs",
        "Match actual page layout",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 13,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Handle Supabase connection errors",
      "description": "As a user, I want graceful handling when database is unavailable.",
      "acceptanceCriteria": [
        "Wrap key Supabase queries in try-catch",
        "On connection error show 'Database temporarily unavailable'",
        "Log error to Sentry with query context",
        "Return empty data with error flag instead of crashing",
        "Apply to brief and profile fetching",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Handle AI API errors",
      "description": "As a user, I want graceful handling when AI service fails.",
      "acceptanceCriteria": [
        "Wrap AI calls in retry logic (3 attempts)",
        "On persistent failure show 'AI service temporarily unavailable'",
        "Log error to Sentry with sanitized prompt context",
        "For suggestions: fall back to template-only results",
        "For brief generation: show error with retry button",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Handle Stripe API errors",
      "description": "As a user, I want graceful handling when payment service fails.",
      "acceptanceCriteria": [
        "Wrap Stripe calls in try-catch",
        "On Stripe down show 'Payment service temporarily unavailable'",
        "Disable buy buttons when Stripe unreachable",
        "Log error to Sentry",
        "Don't expose raw Stripe errors to users",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Create service health check endpoint",
      "description": "As a developer, I need to check if services are healthy.",
      "acceptanceCriteria": [
        "Create /app/api/health/route.ts",
        "Check Supabase connection",
        "Return { status: 'healthy' | 'degraded' | 'unhealthy', services: {} }",
        "Cache result for 30 seconds",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Add user context to Sentry errors",
      "description": "As a developer, I need user context in Sentry errors.",
      "acceptanceCriteria": [
        "On user login call Sentry.setUser({ id, email })",
        "On logout call Sentry.setUser(null)",
        "Add custom tags: environment, version",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Create 404 not found page",
      "description": "As a user, I want a friendly 404 page.",
      "acceptanceCriteria": [
        "Create /app/not-found.tsx",
        "Display: 'Page not found' message",
        "Include 'Go home' button",
        "Match site styling",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 19,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-020",
      "title": "Create offline detection banner",
      "description": "As a user, I want to know when I'm offline.",
      "acceptanceCriteria": [
        "Create /app/components/OfflineBanner.tsx",
        "Use navigator.onLine and online/offline events",
        "Show banner at top when offline",
        "Message: 'You're offline. Some features may be unavailable.'",
        "Auto-hide when back online",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    }
  ]
}
