{
  "project": "State of Clarity",
  "branchName": "ralph/accountability-tracker-data-integration",
  "description": "Accountability Tracker Data Integration - UK Public Records Service for Companies House, Charity Commission, Register of Interests, Electoral Commission, and Contracts Finder. PRD 2 of 6 (see tasks/prd-accountability-tracker-overview.md).",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Companies House API service file",
      "description": "As a developer, I need a service file for Companies House API integration with authentication.",
      "acceptanceCriteria": [
        "Create file: /lib/services/companies-house-api.ts",
        "Add COMPANIES_HOUSE_API_KEY to .env.example with placeholder",
        "Create function getCompaniesHouseAuthHeader() that returns Basic Auth header (base64 encode API_KEY:)",
        "Export async function searchOfficers(name: string) that calls /search/officers endpoint",
        "Export async function getOfficerAppointments(officerId: string) that calls /officers/{id}/appointments",
        "Handle 404 responses by returning empty array (not throwing)",
        "Add JSDoc comments to all exported functions",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Implement fetchCompaniesHouseProfile function",
      "description": "As a developer, I need a function to fetch and parse Companies House data into typed CompanyRecord objects.",
      "acceptanceCriteria": [
        "Add to /lib/services/companies-house-api.ts",
        "Export async function fetchCompaniesHouseProfile(entityName: string): Promise<{ records: CompanyRecord[]; sources: InvestigationSource[] }>",
        "Search for officers matching entityName",
        "For each officer found, fetch their appointments",
        "Map appointments to CompanyRecord[] type from /lib/types/accountability.ts",
        "Create InvestigationSource objects with sourceType 'companies_house' and verificationStatus 'verified'",
        "Implement retry logic with exponential backoff (3 attempts, 1s/2s/4s delays)",
        "Return empty arrays if no matches found (graceful handling)",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Create Charity Commission parser",
      "description": "As a developer, I need to scrape Charity Commission data via Tavily search.",
      "acceptanceCriteria": [
        "Create file: /lib/parsers/charity-commission-parser.ts",
        "Export async function fetchCharityCommissionData(entityName: string): Promise<{ records: CharityRecord[]; sources: InvestigationSource[] }>",
        "Use existing Tavily service to search with query: \"[name]\" trustee site:register-of-charities.charitycommission.gov.uk",
        "Parse charity numbers from URLs using regex /charity/(\\d+)/",
        "Map results to CharityRecord[] type",
        "Create InvestigationSource objects with verificationStatus 'unverified'",
        "Return empty arrays if no results (graceful handling)",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Create Parliament Register of Interests parser",
      "description": "As a developer, I need to search Register of Members' Interests via Tavily.",
      "acceptanceCriteria": [
        "Create file: /lib/parsers/parliament-parser.ts",
        "Export async function fetchRegisterOfInterests(entityName: string): Promise<{ records: InterestDeclaration[]; sources: InvestigationSource[] }>",
        "Use Tavily to search: \"[name]\" \"register of interests\" site:parliament.uk",
        "Parse interest categories from content (Employment, Donations, Land, Shareholdings)",
        "Map results to InterestDeclaration[] type",
        "Create InvestigationSource objects with verificationStatus 'unverified'",
        "Return empty arrays if entity is not an MP (graceful handling)",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Create Electoral Commission parser",
      "description": "As a developer, I need to search Electoral Commission donation data via Tavily.",
      "acceptanceCriteria": [
        "Create file: /lib/parsers/electoral-commission-parser.ts",
        "Export async function fetchElectoralCommissionData(entityName: string): Promise<{ records: Donation[]; sources: InvestigationSource[] }>",
        "Use Tavily to search: \"[name]\" donations site:search.electoralcommission.org.uk",
        "Extract donation amounts using regex for £ symbols (e.g., /£([\\d,]+)/)",
        "Map results to Donation[] type",
        "Create InvestigationSource objects with verificationStatus 'unverified'",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Create Contracts Finder parser",
      "description": "As a developer, I need to search government contracts via Tavily.",
      "acceptanceCriteria": [
        "Create file: /lib/parsers/contracts-finder-parser.ts",
        "Export async function fetchGovernmentContracts(entityName: string): Promise<{ records: Contract[]; sources: InvestigationSource[] }>",
        "Use Tavily to search: \"[name]\" site:contractsfinder.service.gov.uk",
        "Extract contract values from content",
        "Map results to Contract[] type",
        "Create InvestigationSource objects with verificationStatus 'unverified'",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Create UK public data orchestrator service",
      "description": "As a developer, I need a main orchestrator that calls all data sources in parallel.",
      "acceptanceCriteria": [
        "Create file: /lib/services/uk-public-data-service.ts",
        "Export async function fetchUKPublicData(targetEntity: string, entityType: EntityType): Promise<UKPublicDataResult>",
        "Define UKPublicDataResult type with: profileData (partial UKProfileData), sources: InvestigationSource[], errors: DataSourceError[]",
        "Define DataSourceError type with: source, message, recoverable boolean",
        "Call all 5 data sources using Promise.allSettled for parallel execution",
        "Wrap each source call in try-catch for graceful degradation",
        "Aggregate results from all sources into single profileData object",
        "Collect all sources and errors arrays",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Add caching to UK public data service",
      "description": "As a developer, I need caching to minimize API costs and improve performance.",
      "acceptanceCriteria": [
        "Add caching wrapper to each data source call in uk-public-data-service.ts",
        "Use existing withCache or fetchWithCache utility if available, else create simple cache wrapper",
        "Cache key format: uk_data:{source}:{normalized_entity_name} (lowercase, trim whitespace)",
        "TTLs: Companies House 24hrs (86400s), Charity 24hrs, Parliament 12hrs (43200s), Electoral 12hrs, Contracts 24hrs",
        "Log cache hits/misses to console for debugging",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Add error logging to Sentry for data sources",
      "description": "As a developer, I need errors logged to Sentry with proper context tags.",
      "acceptanceCriteria": [
        "Import Sentry in uk-public-data-service.ts",
        "Log all caught errors to Sentry with captureException",
        "Add tags: component: 'uk-public-data', source: '[source_name]', entity: '[normalized_name]'",
        "Add extra context: entityType, errorType (transient/permanent)",
        "Mark transient errors (timeout, 500, 503) as recoverable: true in errors array",
        "Mark permanent errors (404, 401, 403) as recoverable: false",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Skip Contracts Finder for individuals",
      "description": "As a developer, I need to only run Contracts Finder for organizations.",
      "acceptanceCriteria": [
        "In uk-public-data-service.ts, check entityType before calling fetchGovernmentContracts",
        "Only call Contracts Finder if entityType === 'organization'",
        "For individuals, set governmentContracts to empty array without making API call",
        "Log skip reason to console: 'Skipping Contracts Finder for individual entity'",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Create unit tests for Companies House API",
      "description": "As a QA engineer, I need unit tests for Companies House integration.",
      "acceptanceCriteria": [
        "Create test file: __tests__/unit/services/companies-house-api.test.ts",
        "Mock fetch for all tests (don't call real API)",
        "Test searchOfficers returns parsed results",
        "Test searchOfficers returns empty array on 404",
        "Test fetchCompaniesHouseProfile maps to CompanyRecord[] correctly",
        "Test retry logic triggers on 500 error",
        "Test retry logic does NOT trigger on 404",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Create unit tests for Tavily parsers",
      "description": "As a QA engineer, I need unit tests for the Tavily-based parsers.",
      "acceptanceCriteria": [
        "Create test file: __tests__/unit/parsers/uk-data-parsers.test.ts",
        "Mock Tavily service for all tests",
        "Test fetchCharityCommissionData parses charity numbers from URLs",
        "Test fetchRegisterOfInterests parses interest categories",
        "Test fetchElectoralCommissionData extracts £ amounts",
        "Test fetchGovernmentContracts extracts contract values",
        "Test all parsers return empty arrays on no results",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Create unit tests for UK public data orchestrator",
      "description": "As a QA engineer, I need unit tests for the orchestrator's graceful degradation.",
      "acceptanceCriteria": [
        "Create test file: __tests__/unit/services/uk-public-data-service.test.ts",
        "Mock all 5 data source functions",
        "Test fetchUKPublicData aggregates results from all sources",
        "Test graceful degradation: mock one source failing, verify others still return data",
        "Test graceful degradation: mock all sources failing, verify returns empty arrays and errors",
        "Test cache logic: verify cached data returned on second call (mock cache)",
        "Test organizations include Contracts Finder, individuals do not",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    }
  ]
}
