{
  "project": "State of Clarity",
  "branchName": "ralph/accountability-tracker-api-layer",
  "description": "Accountability Tracker API Layer - REST endpoints with SSE streaming for investigation generation, fetch, export, and list. Includes credit integration and rate limiting. PRD 4 of 6 (see tasks/prd-accountability-tracker-overview.md).",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create SSE helper functions",
      "description": "As a developer, I need SSE helper functions for consistent streaming across endpoints.",
      "acceptanceCriteria": [
        "Create file: /lib/api/sse-helpers.ts",
        "Export function createSSEResponse(stream: ReadableStream): Response with headers Content-Type: text/event-stream, Cache-Control: no-cache, Connection: keep-alive",
        "Export function sendSSE(controller: ReadableStreamDefaultController, event: string, data: object): void",
        "sendSSE formats as: event: {event}\\ndata: {JSON.stringify(data)}\\n\\n",
        "Use TextEncoder to encode messages as UTF-8",
        "Add JSDoc comments",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create list investigations endpoint",
      "description": "As a frontend, I need an endpoint to list user's investigation history.",
      "acceptanceCriteria": [
        "Create file: /app/api/accountability/route.ts",
        "GET method with withAuth middleware",
        "Call listUserInvestigations(user.id, 50) from accountability-service",
        "Return JSON: { investigations: AccountabilityInvestigation[] }",
        "Investigations ordered by created_at DESC",
        "Limit to 50 most recent",
        "Return empty array if no investigations",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Create fetch investigation endpoint",
      "description": "As a frontend, I need an endpoint to fetch a single investigation by ID.",
      "acceptanceCriteria": [
        "Create file: /app/api/accountability/[id]/route.ts",
        "GET method with withAuth middleware",
        "Parse id from route params",
        "Call getInvestigation(id) from accountability-service",
        "Return 404 { error: 'Investigation not found' } if null",
        "Verify investigation.user_id === user.id, return 403 if not",
        "Call getInvestigationSources(id) to include sources",
        "Return JSON: { investigation: { ...investigation, sources } }",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Create export endpoint with redirect",
      "description": "As a frontend, I need an endpoint to redirect to the print page for PDF export.",
      "acceptanceCriteria": [
        "Create file: /app/api/accountability/[id]/export/route.ts",
        "GET method with withAuth middleware",
        "Parse id from route params",
        "Call getInvestigation(id) from accountability-service",
        "Return 404 if investigation not found",
        "Verify investigation.user_id === user.id, return 403 if not",
        "Redirect to /accountability/{id}/print with 302 status",
        "Use NextResponse.redirect()",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Create generation endpoint skeleton with auth and rate limiting",
      "description": "As a developer, I need the generation endpoint structure with middleware.",
      "acceptanceCriteria": [
        "Create file: /app/api/accountability/generate/route.ts",
        "POST method with withAuth middleware",
        "Add rate limiting: 3 requests per hour per user (use existing withRateLimit if available)",
        "Parse request body: { targetEntity: string, ethicsAcknowledged: boolean }",
        "Validate ethicsAcknowledged is true, return 400 { error: 'Ethics acknowledgment required' } if false",
        "Validate targetEntity is non-empty string",
        "Log request: console.log('Generating investigation for:', targetEntity)",
        "Return placeholder 200 response for now",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Add credit check and deduction to generation endpoint",
      "description": "As a system, I need to check and deduct credits before generation.",
      "acceptanceCriteria": [
        "Import credit service functions from /lib/services/credit-service.ts",
        "Check user has â‰¥1 credit via hasCredits(user.id, 1) or equivalent",
        "Return 402 { error: 'Insufficient credits', redirectTo: '/credits' } if no credits",
        "Create investigation record via createInvestigation()",
        "Deduct 1 credit via deductCredits() with investigationId and description",
        "Log credit deduction: console.log('Credit deducted for investigation:', investigationId)",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Implement SSE streaming in generation endpoint",
      "description": "As a developer, I need to stream progress events during investigation generation.",
      "acceptanceCriteria": [
        "Import SSE helpers from /lib/api/sse-helpers.ts",
        "Create ReadableStream with start(controller) callback",
        "Call generateAccountabilityReport() with callbacks object",
        "On onAgentStarted: sendSSE(controller, 'agent_started', { agent, timestamp })",
        "On onAgentCompleted: sendSSE(controller, 'agent_completed', { agent, duration, timestamp })",
        "On onStageChanged: sendSSE(controller, 'stage_changed', { stage, timestamp })",
        "On completion: sendSSE(controller, 'complete', { investigationId, qualityScore, timestamp })",
        "Return createSSEResponse(stream)",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Add quality gate refund logic to generation endpoint",
      "description": "As a system, I need to refund credits if quality score is below threshold.",
      "acceptanceCriteria": [
        "After generation completes, check qualityScore from result",
        "If qualityScore < 6.0, call refundCredits(user.id, 1, investigationId, 'Quality gate failed')",
        "Include creditRefunded: true in SSE complete event if refunded",
        "Log refund: console.log('Credit refunded - quality gate failed:', qualityScore)",
        "If qualityScore >= 6.0, set creditRefunded: false in complete event",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Add error handling and refund on failure",
      "description": "As a system, I need to handle errors gracefully and refund on generation failure.",
      "acceptanceCriteria": [
        "Wrap generation logic in try-catch",
        "On error: call refundCredits(user.id, 1, investigationId, 'Generation failed')",
        "Send SSE error event: sendSSE(controller, 'error', { message, creditRefunded: true, timestamp })",
        "Close stream with controller.close()",
        "Log error to console with context: console.error('Generation failed:', error)",
        "Don't throw - always return SSE response even on error",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Create unit tests for list endpoint",
      "description": "As a QA engineer, I need unit tests for the list investigations endpoint.",
      "acceptanceCriteria": [
        "Create test file: __tests__/unit/api/accountability-list.test.ts",
        "Mock withAuth middleware to provide user",
        "Mock listUserInvestigations service function",
        "Test returns investigations array for authenticated user",
        "Test returns empty array when no investigations",
        "Test returns 401 when not authenticated",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Create unit tests for fetch endpoint",
      "description": "As a QA engineer, I need unit tests for the fetch investigation endpoint.",
      "acceptanceCriteria": [
        "Create test file: __tests__/unit/api/accountability-fetch.test.ts",
        "Mock getInvestigation and getInvestigationSources",
        "Test returns investigation with sources for owner",
        "Test returns 404 when investigation not found",
        "Test returns 403 when user doesn't own investigation",
        "Test includes sources array in response",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Create unit tests for generation endpoint",
      "description": "As a QA engineer, I need unit tests for the generation endpoint.",
      "acceptanceCriteria": [
        "Create test file: __tests__/unit/api/accountability-generate.test.ts",
        "Mock all service functions (credits, investigation, generation)",
        "Test returns 400 when ethicsAcknowledged is false",
        "Test returns 402 when insufficient credits",
        "Test deducts credit before generation starts",
        "Test refunds credit when quality score < 6.0",
        "Test refunds credit on generation error",
        "Test SSE events are properly formatted",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Create unit tests for export endpoint",
      "description": "As a QA engineer, I need unit tests for the export redirect endpoint.",
      "acceptanceCriteria": [
        "Create test file: __tests__/unit/api/accountability-export.test.ts",
        "Mock getInvestigation service function",
        "Test redirects to /accountability/{id}/print for owner",
        "Test returns 404 when investigation not found",
        "Test returns 403 when user doesn't own investigation",
        "Test redirect status is 302",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    }
  ]
}
