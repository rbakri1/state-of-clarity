# Ralph Progress Log
Started: Sun 11 Jan 2026 17:31:07 +04

## Codebase Patterns
- Use lucide-react for icons (AlertTriangle, ChevronDown, ChevronUp, RefreshCw)
- Error components use red-50/red-950 bg with red-200/red-800 borders for dark mode support
- Use "use client" directive for components with useState or interactivity
- No cn utility - use template literals for className concatenation: `${base} ${custom}`
- Use Tailwind animate-pulse for skeleton/loading states
- Use `safeQuery` from lib/supabase/safe-query.ts for Supabase queries with error handling
- Supabase query functions use PromiseLike (not Promise) for type compatibility with PostgrestBuilder
- Use `safeAICall` from lib/ai/safe-ai-call.ts for AI API calls with retry logic (3 attempts) and Sentry logging
- Use `safeStripeCall` from lib/stripe/safe-stripe-call.ts for Stripe API calls with Sentry logging and user-friendly errors
- Use `withCache` from lib/cache/with-cache.ts to cache any async function result with TTL
- Cache key format convention: `{resource}:{id}` e.g., `brief:abc123`
- Vercel KV uses `kvClient` export from `/lib/cache/kv-client.ts` with automatic fallback to in-memory
---

## 2026-01-11 17:35 - US-009
Thread: https://ampcode.com/threads/T-019bad40-e1da-729c-9c27-b468fd383615
- Implemented ErrorMessage component at /app/components/ErrorMessage.tsx
- Props: title, message, details (optional), onRetry (optional)
- Friendly AlertTriangle icon, collapsible technical details section
- "Try again" button only shows when onRetry callback provided
- Files changed: app/components/ErrorMessage.tsx
- **Learnings for future iterations:**
  - Follow existing ErrorBoundary styling patterns for consistency
  - Use collapsible details pattern with useState for show/hide toggle
---

## 2026-01-11 18:10 - US-010
Thread: https://ampcode.com/threads/T-019bad42-e43c-7506-81e2-a86d988af9fb
- Created error message mapping at /lib/errors/error-messages.ts
- Maps all error codes from api-error.ts plus NETWORK_ERROR and UNKNOWN fallback
- FriendlyError interface with title and message fields
- Two helper functions: getFriendlyError(code) and getErrorByStatusCode(statusCode)
- Files changed: lib/errors/error-messages.ts
- **Learnings for future iterations:**
  - Reuse ErrorCodes from api-error.ts for type safety
  - Include UNKNOWN as default fallback for any unmapped error codes
---

## 2026-01-11 18:45 - US-011
Thread: https://ampcode.com/threads/T-019bad44-b2ad-7018-889b-a26a076e8ec9
- Created Skeleton component at /app/components/Skeleton.tsx
- Variants: text, paragraph, card, avatar, button
- Uses Tailwind animate-pulse for subtle loading animation
- Accepts className prop for custom sizing
- Uses aria-hidden="true" for accessibility
- Files changed: app/components/Skeleton.tsx
- **Learnings for future iterations:**
  - Codebase doesn't have a cn utility - use template literals for class concatenation
  - Tailwind's animate-pulse works well for skeleton loading states
  - Use gray-200/gray-700 for light/dark mode skeleton backgrounds
---

## 2026-01-11 19:15 - US-012
Thread: https://ampcode.com/threads/T-019bad48-5423-748c-98b5-e20682f37d5c
- Created loading skeleton for brief page at /app/brief/[id]/loading.tsx
- Skeletons for: header (title, clarity score, tags), reading level selector, summary, structured data sections, narrative, sources grid, feedback section
- Matches BriefPageClient.tsx layout structure exactly
- Uses existing Skeleton component with variants: text, paragraph, card, button
- Files changed: app/brief/[id]/loading.tsx
- **Learnings for future iterations:**
  - Next.js app router loading.tsx files are automatically used during Suspense boundaries
  - Match skeleton layout closely to actual page to minimize layout shift
  - Use Skeleton variant="card" for grid items like sources
---

## 2026-01-11 19:55 - US-013
Thread: https://ampcode.com/threads/T-019bad4d-f67c-7471-bc50-ba184c54dea2
- Created homepage loading skeleton at /app/loading.tsx
- Skeletons for: header, hero section, search input, 3 feature cards, 3 showcase brief cards, footer
- Matches page.tsx layout structure exactly
- Uses existing Skeleton component with appropriate variants and sizing
- Files changed: app/loading.tsx
- **Learnings for future iterations:**
  - Homepage has 5 main sections: header, hero, features grid, showcase briefs grid, footer
  - Use Array.from({ length: N }) for generating repeated skeleton elements in grids
  - Match skeleton dimensions to actual content (e.g., h-12 for titles, h-6 for subtitles)
---

## 2026-01-11 20:30 - US-014
Thread: https://ampcode.com/threads/T-019bad51-20fb-7411-8faf-b0708ffd286a
- Created safeQuery utility at /lib/supabase/safe-query.ts
- Wraps Supabase queries with try-catch, logs to Sentry with query context
- Returns SafeQueryResult with data, error, and isConnectionError flag
- Detects connection errors by error codes and message keywords
- Updated getBriefById in brief-service.ts to use safeQuery
- Updated profile API route to use safeQuery for all database queries
- Files changed: lib/supabase/safe-query.ts, lib/services/brief-service.ts, app/api/profile/route.ts
- **Learnings for future iterations:**
  - Use PromiseLike instead of Promise for Supabase query function types (PostgrestBuilder compatibility)
  - SafeQueryResult.isConnectionError distinguishes database-down from other errors
  - Sentry.captureException with tags and extra context for better error tracking
---

## 2026-01-11 21:15 - US-015
Thread: https://ampcode.com/threads/T-019bad55-192a-71cd-a80c-996da067e0e7
- Created safeAICall utility at /lib/ai/safe-ai-call.ts
- Wraps AI API calls with retry logic (3 attempts, exponential backoff with jitter)
- Logs to Sentry with sanitized prompt context (truncated, email/phone redacted)
- Returns SafeAICallResult with data, error, and isAIServiceError flag
- Updated questions/suggest route to use safeAICall - falls back to template-only on AI failure
- Updated research-agent.ts: wrapped Tavily search and political lean classification
- Updated brief generation route to show friendly AI error messages
- Added AI_SERVICE_ERROR to error-messages.ts
- Files changed: lib/ai/safe-ai-call.ts, app/api/questions/suggest/route.ts, lib/agents/research-agent.ts, app/api/briefs/generate/route.ts, lib/errors/error-messages.ts
- **Learnings for future iterations:**
  - Follow safeQuery pattern for AI calls - same structure, different error detection
  - Sanitize prompts before logging: truncate, redact emails/phones
  - For suggestions: silent fallback to template-only results (return empty array)
  - For brief generation: propagate error with user-friendly message
---

## 2026-01-11 22:00 - US-016
Thread: https://ampcode.com/threads/T-019bad5a-5ebc-70cb-aea2-b82357fbb81a
- Created safeStripeCall utility at /lib/stripe/safe-stripe-call.ts
- Wraps Stripe API calls with try-catch, logs to Sentry, returns user-friendly errors
- Detects Stripe service errors (connection, rate limit, API errors)
- Never exposes raw Stripe errors to users - sanitizes all error messages
- Added checkStripeHealth() function for health checks
- Created /app/api/payments/health/route.ts with 30-second cache
- Updated create-checkout route to use safeStripeCall
- Updated credits page to check payment service health on load
- Disabled buy buttons when payment service unavailable (shows "Unavailable")
- Added yellow warning banner when payment service is down
- Added PAYMENT_SERVICE_ERROR to error-messages.ts
- Updated payment-retry-service.ts to use safeStripeCall
- Updated webhook route with Sentry logging
- Files changed: lib/stripe/safe-stripe-call.ts, app/api/payments/health/route.ts, app/api/payments/create-checkout/route.ts, app/credits/page.tsx, lib/errors/error-messages.ts, lib/services/payment-retry-service.ts, app/api/webhooks/stripe/route.ts
- **Learnings for future iterations:**
  - Follow safeQuery/safeAICall pattern for safeStripeCall - consistent error handling structure
  - Use checkStripeHealth() with stripe.balance.retrieve() as lightweight health check
  - Never expose raw Stripe errors - always sanitize with user-friendly messages
  - Add health check endpoint for UI to disable features when service is unavailable
---

## 2026-01-11 22:45 - US-017
Thread: https://ampcode.com/threads/T-019bad5f-4251-7640-83c4-23f43752a381
- Created service health check endpoint at /app/api/health/route.ts
- Checks Supabase connection using lightweight query (briefs table)
- Returns { status: 'healthy' | 'degraded' | 'unhealthy', services: { supabase } }
- Includes latency measurement and error details
- 30-second cache to prevent excessive checks
- Detects connection errors vs other failures for degraded state
- Files changed: app/api/health/route.ts
- **Learnings for future iterations:**
  - Follow payments/health endpoint pattern for caching
  - Use lightweight queries (select id limit 1) for connection checks
  - Consider latency > 5s as "degraded" not "unhealthy"
---

## 2026-01-11 23:30 - US-018
Thread: https://ampcode.com/threads/T-019bad60-fe03-73c8-8360-84827c4cfda0
- Added Sentry user context to UserMenu.tsx
- On auth state change, calls Sentry.setUser({ id, email }) for logged-in users
- On logout (handleSignOut) or no user, calls Sentry.setUser(null)
- Updated all 3 Sentry config files with environment and version tags
- Added release, environment, and initialScope.tags to client, server, and edge configs
- Files changed: app/components/UserMenu.tsx, sentry.client.config.ts, sentry.server.config.ts, sentry.edge.config.ts
- **Learnings for future iterations:**
  - UserMenu.tsx is the central place for auth state changes - use onAuthStateChange callback
  - Sentry.setUser() should be called in fetchUser() which handles both login and state recovery
  - Use consistent APP_VERSION constant across all Sentry config files
  - environment defaults to NODE_ENV, release uses format "project-name@version"
---

## 2026-01-11 - US-019
Thread: https://ampcode.com/threads/T-019badfe-3201-753c-9ccc-b6982160268a
- Created 404 not found page at /app/not-found.tsx
- Page displays: large "404" text, "Page not found" heading, helpful message
- Includes "Go home" button (primary) and "Browse briefs" secondary button
- Uses lucide-react Home and Search icons
- Matches site styling with gradient background, dark mode support
- Files changed: app/not-found.tsx
- **Learnings for future iterations:**
  - Next.js app router uses not-found.tsx for custom 404 pages
  - Use same gradient background (from-white to-gray-50) as homepage for consistency
  - Include secondary navigation option (Browse briefs) to help users find content
---

## 2026-01-11 - US-020
Thread: https://ampcode.com/threads/T-019bae05-034f-77f8-8035-d3c36d30a353
- Created OfflineBanner component at /app/components/OfflineBanner.tsx
- Uses navigator.onLine and window online/offline events for detection
- Shows fixed yellow banner at top of page when offline
- Message: "You're offline. Some features may be unavailable."
- Auto-hides when connection restored
- Uses WifiOff icon from lucide-react
- Added to app/layout.tsx to show globally
- Files changed: app/components/OfflineBanner.tsx, app/layout.tsx
- **Learnings for future iterations:**
  - Use useState with useEffect for client-side only state like navigator.onLine
  - Initial state should be false (assume online) since SSR doesn't have navigator
  - Fixed positioning with z-50 ensures banner appears above all content
---

## 2026-01-11 - Cache Infrastructure (prep for future caching epic)
Thread: https://ampcode.com/threads/T-019bae56-a4c5-712c-85a4-719601a1ed38
- Created cache infrastructure for future Brief Caching & Performance epic
- Created /lib/cache/kv-client.ts with Vercel KV client and in-memory fallback
- Created /lib/cache/with-cache.ts with generic cache wrapper utility
- Created /lib/cache/invalidate.ts with cache invalidation utilities
- Updated getBriefById in brief-service.ts to use withCache with key 'brief:{id}' and TTL 300s
- Installed @vercel/kv package
- Added KV_REST_API_URL and KV_REST_API_TOKEN to .env.example
- Documented Vercel KV setup in SETUP.md (Step 7)
- Files changed: lib/cache/kv-client.ts, lib/cache/with-cache.ts, lib/cache/invalidate.ts, lib/services/brief-service.ts, .env.example, SETUP.md, package.json
- **Learnings for future iterations:**
  - withCache wraps any async fn: `withCache(key, fn, ttlSeconds)`
  - Cache errors are gracefully handled - never block main operation
  - Use invalidateCache('brief:${id}') to clear specific cache
  - Use invalidatePattern('brief:*') to clear all brief caches
  - In-memory fallback works for local dev without Vercel KV configured
---
