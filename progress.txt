# Ralph Progress Log
Started: Sat 10 Jan 2026 10:27:18 +04

## Codebase Patterns
- Database types are defined in lib/supabase/client.ts (not a separate types.ts file)
- Browser-safe Supabase client: use lib/supabase/browser.ts (not client.ts) in client components to avoid next/headers import errors
- Use `IF NOT EXISTS` for migrations to make them idempotent
- RLS policies: users can SELECT their own, service_role can manage all
- Credit amounts: positive = purchase/refund/bonus, negative = usage/expiry
- Supabase chained queries cause TypeScript `never` inference issues - use `(supabase as any)` for update/insert operations with helper functions
- Stripe client in lib/stripe/client.ts uses lazy init via getStripe() to avoid build-time errors
- For Supabase select queries, cast result with `as TypeName | null` to fix `never` type inference
- Client components needing auth-protected data should call API routes (not service-role directly)
- Wrap useSearchParams() in Suspense boundary for Next.js static page generation

---

## 2026-01-10 - US-001
Thread: https://ampcode.com/threads/T-019ba696-7eeb-75ea-9215-46281cbf853c
- Created migration 008_add_credits_tables.sql with 4 tables:
  - credit_packages: purchasable credit bundles
  - user_credits: per-user balance tracking
  - credit_batches: individual purchases with expiry dates
  - credit_transactions: audit log of all movements
- Added TypeScript types to Database interface in client.ts
- Fixed pre-existing type errors in app/brief/[id]/page.tsx
- **Learnings for future iterations:**
  - The prd.json and progress.txt get stashed when switching branches - be careful with git stash/checkout
  - Pre-existing type errors need to be fixed before build passes
  - Database types live in client.ts on this branch (not a separate types.ts)
---

## 2026-01-10 - US-002
Thread: https://ampcode.com/threads/T-019ba69b-c5a0-72d7-8a88-fdebe47f437f
- Created lib/services/credit-service.ts with 5 main functions:
  - getBalance(userId): Get user's credit balance
  - hasCredits(userId, amount): Check if user has enough credits
  - deductCredits(userId, amount, briefId, description): Deduct from oldest non-expired batches (FIFO)
  - addCredits(userId, amount, transactionType, stripePaymentId, expiresAt): Add credits with expiry tracking
  - refundCredits(userId, amount, briefId, reason): Refund credits for failed briefs
- All operations create transaction records for audit trail
- **Learnings for future iterations:**
  - Supabase v2 with TypeScript has `never` type inference bugs on chained queries
  - Solution: wrap update/insert in helper functions using `(supabase as any)` cast
  - Service follows pattern: getClient() returns typed client, helper functions do mutations
---

## 2026-01-10 - US-003
Thread: https://ampcode.com/threads/T-019ba6a5-59bb-741e-9999-0c321fd1256d
- Added expireOldCredits() function to expire batches past their expiry date
- Added getExpiringCreditsWarnings() to find credits expiring within 30 days
- Added sendExpiryWarningNotifications() placeholder for future notification integration
- **Learnings for future iterations:**
  - FIFO deduction was already implemented in deductCredits() from US-002
  - Batch expiry set credits_remaining to 0 and deducts from user_credits balance
  - Expiry transactions logged with type 'expiry' and negative amount
---

## 2026-01-10 - US-004
Thread: https://ampcode.com/threads/T-019ba6a7-80f8-7326-8bfb-6017e5fc0622
- Installed stripe and @stripe/stripe-js packages
- Created lib/stripe/client.ts with server-side Stripe client
- Added STRIPE_SECRET_KEY, NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY, STRIPE_WEBHOOK_SECRET to .env.example
- Created migration 009_seed_credit_packages.sql with 4 packages
- Added comprehensive Stripe setup documentation to SETUP.md
- **Learnings for future iterations:**
  - Use `apiVersion: '2025-12-15.clover'` for current Stripe SDK (API version must match installed package)
  - Also needed to install @supabase/ssr to fix pre-existing type error
---

## 2026-01-10 - US-005
Thread: https://ampcode.com/threads/T-019ba6aa-40f6-724e-b40b-1a46a6899d64
- Created /app/api/payments/create-checkout/route.ts
- Accepts package_id, validates package exists and is active
- Creates Stripe checkout session with mode: 'payment'
- Sets success_url to /credits/success and cancel_url to /credits
- Includes user_id, package_id, and credits in session and payment_intent metadata
- Returns session url for client-side redirect
- Fixed Stripe client to use lazy initialization (required for Next.js build)
- Installed tailwindcss-animate (missing dependency)
- **Learnings for future iterations:**
  - Stripe client must be lazy-initialized to avoid throwing during Next.js static page generation
  - Use type casting with `as CreditPackage | null` to work around Supabase's `never` type inference issue
  - Payment method types only `['card']` is used; Apple Pay and Google Pay are enabled via Stripe Dashboard configuration, not via API
---

## 2026-01-10 - US-006
Thread: https://ampcode.com/threads/T-019ba6ad-554a-72ea-8ebd-a1e1d0f3867d
- Created /app/api/webhooks/stripe/route.ts
- Verifies webhook signature using STRIPE_WEBHOOK_SECRET
- Handles checkout.session.completed event
- Extracts user_id, package_id, and credits from session metadata
- Adds credits to user via addCredits() which creates credit_batches with 12-month expiry
- Returns { received: true } on success
- **Learnings for future iterations:**
  - Use getStripe() directly for webhook signature verification, not the proxy object
  - Credits value stored as string in metadata, needs parseInt
  - credit_batches record is created inside addCredits(), no separate call needed
---

## 2026-01-10 - US-007
Thread: https://ampcode.com/threads/T-019ba6ae-e8dd-702b-a60f-07c2b97434f0
- Created migration 010_add_payment_retries_table.sql with payment_retries table
- Added PaymentRetryStatus type and payment_retries types to Database interface
- Created lib/services/payment-retry-service.ts with:
  - createPaymentRetry(), handlePaymentFailure(), markRetrySucceeded()
  - processRetry(), processAllPendingRetries() for scheduled retry processing
  - getUserPendingRetries() for UI display
- Updated webhook to handle payment_intent.payment_failed and payment_intent.succeeded events
- Retry schedule: 1 hour, 6 hours, 24 hours (3 attempts max)
- After 3 failures, logs notification placeholder
- **Learnings for future iterations:**
  - Follow same pattern as credit-service.ts for helper functions with (supabase as any) cast
  - Payment retries need both webhook handlers and a scheduled job (processAllPendingRetries)
  - Payment intent metadata must include user_id for retry logic to work
---

## 2026-01-10 - US-008
Thread: https://ampcode.com/threads/T-019ba6b2-3cbf-76ea-88ff-805490f2c892
- Created /app/credits/page.tsx - buy credits page with package cards
- Created /app/api/credits/route.ts - API endpoint to fetch packages and balance
- Displays current credit balance at top, 4 package cards with pricing info
- "Most Popular" badge on Standard package, "Best value" shown on lowest per-credit price
- Buy button triggers Stripe checkout redirect via create-checkout API
- **Learnings for future iterations:**
  - Client components fetching auth-protected data need a server API route (credit-service uses service role)
  - Dynamic API routes using cookies show expected warning during build but still work correctly at runtime
  - dev-browser skill not available in this workspace; browser verification skipped
---

## 2026-01-10 - US-009
Thread: https://ampcode.com/threads/T-019ba6b4-fbb1-7434-83ad-32c76dd89f41
- Created /app/components/CreditBalance.tsx - reusable component for header nav
- Created /app/api/credits/balance/route.ts - lightweight endpoint returning only balance
- Component shows: balance with coin icon, warning styling (amber) when <= 2 credits, "Buy credits" button when 0
- Integrated into home page and credits page headers
- Component only renders when user is authenticated (gracefully hides if not)
- **Learnings for future iterations:**
  - No UserMenu component exists - integrated directly into header nav on each page
  - Keep API routes focused: /credits/balance returns just balance, /credits returns packages too
  - Use amber warning colors for low balance states (amber-100/700 light, amber-900/300 dark)
---

## 2026-01-10 - US-010
Thread: https://ampcode.com/threads/T-019ba6b7-810f-722d-81cf-29972e30e4d8
- Created /app/api/briefs/generate/route.ts - main brief generation API with credit integration
- Checks hasCredits(userId, 1) before starting generation
- Returns 402 with error message and /credits link if insufficient credits
- Deducts 1 credit via deductCredits() when generation starts (with brief_id)
- Refunds credit via refundCredits() if quality gate < 6.0 or generation fails
- All transactions logged with brief_id for audit trail
- Updated home page to call the new API and display credit-related errors
- **Learnings for future iterations:**
  - The brief generation orchestrator was a TODO - created as API route /api/briefs/generate
  - Use HTTP 402 Payment Required for insufficient credits scenarios
  - Clarity score calculation is a placeholder - will integrate real evaluation in future
  - refundCredits creates a new batch with 12-month expiry (same as addCredits pattern)
---

## 2026-01-10 - US-011
Thread: https://ampcode.com/threads/T-019ba6ba-fedd-7423-bda5-159fd449e600
- Created /app/credits/success/page.tsx - purchase success confirmation page
- Created /app/api/payments/session/route.ts - retrieves Stripe session details for success page
- Shows "Thank you for your purchase!" heading with success checkmark
- Displays credits added, new total balance, and expiry date (12 months from now)
- Primary CTA: "Generate a brief" linking to home
- Wrapped useSearchParams in Suspense boundary (Next.js requirement)
- **Learnings for future iterations:**
  - useSearchParams must be wrapped in Suspense boundary for Next.js static page generation
  - Stripe session.metadata contains user_id, package_id, credits from checkout creation
  - Calculate expiry date client-side (12 months from now) rather than storing/retrieving
---

## 2026-01-10 - US-012
Thread: https://ampcode.com/threads/T-019ba6be-0471-748f-af8a-b519cdbda010
- Created /app/credits/history/page.tsx - transaction history with pagination
- Created /app/api/credits/history/route.ts - fetches transactions with pagination
- Table displays: date, type (with color-coded badges), amount (+/-), description
- Links usage transactions to /brief/[id] if brief_id exists
- Pagination shows when >20 transactions (page size 20)
- **Learnings for future iterations:**
  - Follow same API route pattern: createServerSupabaseClient, check user, cast types
  - Use color-coded badges for transaction types (green=purchase, blue=usage, amber=refund, red=expiry)
  - Pagination needs both count query and range query to Supabase
---

## 2026-01-10 - US-013
Thread: https://ampcode.com/threads/T-019ba6c0-44a5-739d-b253-4a2011553ec9
- Created /app/components/LowBalanceWarning.tsx - dismissible warning banner component
- Shows amber warning when balance > 0 and balance <= 2 credits
- Features: dismiss button uses sessionStorage to hide for current session
- "Top up now" button links to /credits page
- Integrated into home page (dashboard) and brief/[id] page
- **Learnings for future iterations:**
  - LowBalanceWarning uses same /api/credits/balance endpoint as CreditBalance component
  - Use sessionStorage (not localStorage) for session-only dismissal
  - Component returns null if balance is 0 (CreditBalance handles that case differently)
---

## 2026-01-10 - US-014
Thread: https://ampcode.com/threads/T-019ba6c2-a2f3-711e-b1fd-dabf831db093
- Verified all acceptance criteria already completed in US-004:
  - Seed migration 009_seed_credit_packages.sql with 4 packages (Single, Starter, Standard, Pro)
  - Stripe product/price creation documented in SETUP.md Step 7 Section 3
  - stripe_price_id placeholders in place
- Build passes with typecheck
- **Learnings for future iterations:**
  - Some stories may duplicate work from earlier stories - verify before implementing
  - Migration 009 was created as part of US-004 Stripe integration
---

## 2026-01-10 - US-015
Thread: https://ampcode.com/threads/T-019ba6c4-05df-73ba-a4bd-6e7eb906ab37
- Created test-payments.ts with comprehensive manual testing checklist
- Documents 10 test cases covering: purchases, credit deductions, refunds, webhooks, insufficient credits, low balance warnings, declines, retry logic, transaction history, and balance display
- Includes Stripe test card numbers (4242... for success, 4000...9995 for decline)
- Prints formatted checklist to console with steps and expected results
- **Learnings for future iterations:**
  - Test scripts should be runnable with `npx tsx` for TypeScript files
  - Good checklist format includes: test ID, description, steps, expected result
  - Document prerequisites (dev server, Stripe keys, webhook forwarding)
---

## 2026-01-10 - Build Fix
Thread: https://ampcode.com/threads/T-019ba6d2-6be2-76a8-b596-7cd85633c096
- Fixed build failures caused by missing lib modules
- Created lib/supabase/browser.ts - browser-safe Supabase client that doesn't import next/headers
- Created lib/reading-history/useReadingHistory.ts hook for reading history fetching
- Created lib/question-history/useQuestionHistory.ts hook for question history fetching
- Committed previously unstaged pages (history, saved, settings, auth/callback)
- **Learnings for future iterations:**
  - lib/supabase/client.ts imports next/headers which makes it server-only
  - Client components MUST use lib/supabase/browser.ts instead of client.ts
  - When git stash/checkout moves between branches, verify all files exist before build
---
