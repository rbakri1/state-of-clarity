# Ralph Progress Log
Started: Sat 10 Jan 2026 10:27:18 +04

## Codebase Patterns
- Database types are defined in lib/supabase/client.ts (not a separate types.ts file)
- Use `IF NOT EXISTS` for migrations to make them idempotent
- RLS policies: users can SELECT their own, service_role can manage all
- Credit amounts: positive = purchase/refund/bonus, negative = usage/expiry
- Supabase chained queries cause TypeScript `never` inference issues - use `(supabase as any)` for update/insert operations with helper functions
- Stripe client in lib/stripe/client.ts uses lazy init via getStripe() to avoid build-time errors
- For Supabase select queries, cast result with `as TypeName | null` to fix `never` type inference
- Client components needing auth-protected data should call API routes (not service-role directly)

---

## 2026-01-10 - US-001
Thread: https://ampcode.com/threads/T-019ba696-7eeb-75ea-9215-46281cbf853c
- Created migration 008_add_credits_tables.sql with 4 tables:
  - credit_packages: purchasable credit bundles
  - user_credits: per-user balance tracking
  - credit_batches: individual purchases with expiry dates
  - credit_transactions: audit log of all movements
- Added TypeScript types to Database interface in client.ts
- Fixed pre-existing type errors in app/brief/[id]/page.tsx
- **Learnings for future iterations:**
  - The prd.json and progress.txt get stashed when switching branches - be careful with git stash/checkout
  - Pre-existing type errors need to be fixed before build passes
  - Database types live in client.ts on this branch (not a separate types.ts)
---

## 2026-01-10 - US-002
Thread: https://ampcode.com/threads/T-019ba69b-c5a0-72d7-8a88-fdebe47f437f
- Created lib/services/credit-service.ts with 5 main functions:
  - getBalance(userId): Get user's credit balance
  - hasCredits(userId, amount): Check if user has enough credits
  - deductCredits(userId, amount, briefId, description): Deduct from oldest non-expired batches (FIFO)
  - addCredits(userId, amount, transactionType, stripePaymentId, expiresAt): Add credits with expiry tracking
  - refundCredits(userId, amount, briefId, reason): Refund credits for failed briefs
- All operations create transaction records for audit trail
- **Learnings for future iterations:**
  - Supabase v2 with TypeScript has `never` type inference bugs on chained queries
  - Solution: wrap update/insert in helper functions using `(supabase as any)` cast
  - Service follows pattern: getClient() returns typed client, helper functions do mutations
---

## 2026-01-10 - US-003
Thread: https://ampcode.com/threads/T-019ba6a5-59bb-741e-9999-0c321fd1256d
- Added expireOldCredits() function to expire batches past their expiry date
- Added getExpiringCreditsWarnings() to find credits expiring within 30 days
- Added sendExpiryWarningNotifications() placeholder for future notification integration
- **Learnings for future iterations:**
  - FIFO deduction was already implemented in deductCredits() from US-002
  - Batch expiry set credits_remaining to 0 and deducts from user_credits balance
  - Expiry transactions logged with type 'expiry' and negative amount
---

## 2026-01-10 - US-004
Thread: https://ampcode.com/threads/T-019ba6a7-80f8-7326-8bfb-6017e5fc0622
- Installed stripe and @stripe/stripe-js packages
- Created lib/stripe/client.ts with server-side Stripe client
- Added STRIPE_SECRET_KEY, NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY, STRIPE_WEBHOOK_SECRET to .env.example
- Created migration 009_seed_credit_packages.sql with 4 packages
- Added comprehensive Stripe setup documentation to SETUP.md
- **Learnings for future iterations:**
  - Use `apiVersion: '2025-12-15.clover'` for current Stripe SDK (API version must match installed package)
  - Also needed to install @supabase/ssr to fix pre-existing type error
---

## 2026-01-10 - US-005
Thread: https://ampcode.com/threads/T-019ba6aa-40f6-724e-b40b-1a46a6899d64
- Created /app/api/payments/create-checkout/route.ts
- Accepts package_id, validates package exists and is active
- Creates Stripe checkout session with mode: 'payment'
- Sets success_url to /credits/success and cancel_url to /credits
- Includes user_id, package_id, and credits in session and payment_intent metadata
- Returns session url for client-side redirect
- Fixed Stripe client to use lazy initialization (required for Next.js build)
- Installed tailwindcss-animate (missing dependency)
- **Learnings for future iterations:**
  - Stripe client must be lazy-initialized to avoid throwing during Next.js static page generation
  - Use type casting with `as CreditPackage | null` to work around Supabase's `never` type inference issue
  - Payment method types only `['card']` is used; Apple Pay and Google Pay are enabled via Stripe Dashboard configuration, not via API
---

## 2026-01-10 - US-006
Thread: https://ampcode.com/threads/T-019ba6ad-554a-72ea-8ebd-a1e1d0f3867d
- Created /app/api/webhooks/stripe/route.ts
- Verifies webhook signature using STRIPE_WEBHOOK_SECRET
- Handles checkout.session.completed event
- Extracts user_id, package_id, and credits from session metadata
- Adds credits to user via addCredits() which creates credit_batches with 12-month expiry
- Returns { received: true } on success
- **Learnings for future iterations:**
  - Use getStripe() directly for webhook signature verification, not the proxy object
  - Credits value stored as string in metadata, needs parseInt
  - credit_batches record is created inside addCredits(), no separate call needed
---

## 2026-01-10 - US-007
Thread: https://ampcode.com/threads/T-019ba6ae-e8dd-702b-a60f-07c2b97434f0
- Created migration 010_add_payment_retries_table.sql with payment_retries table
- Added PaymentRetryStatus type and payment_retries types to Database interface
- Created lib/services/payment-retry-service.ts with:
  - createPaymentRetry(), handlePaymentFailure(), markRetrySucceeded()
  - processRetry(), processAllPendingRetries() for scheduled retry processing
  - getUserPendingRetries() for UI display
- Updated webhook to handle payment_intent.payment_failed and payment_intent.succeeded events
- Retry schedule: 1 hour, 6 hours, 24 hours (3 attempts max)
- After 3 failures, logs notification placeholder
- **Learnings for future iterations:**
  - Follow same pattern as credit-service.ts for helper functions with (supabase as any) cast
  - Payment retries need both webhook handlers and a scheduled job (processAllPendingRetries)
  - Payment intent metadata must include user_id for retry logic to work
---

## 2026-01-10 - US-008
Thread: https://ampcode.com/threads/T-019ba6b2-3cbf-76ea-88ff-805490f2c892
- Created /app/credits/page.tsx - buy credits page with package cards
- Created /app/api/credits/route.ts - API endpoint to fetch packages and balance
- Displays current credit balance at top, 4 package cards with pricing info
- "Most Popular" badge on Standard package, "Best value" shown on lowest per-credit price
- Buy button triggers Stripe checkout redirect via create-checkout API
- **Learnings for future iterations:**
  - Client components fetching auth-protected data need a server API route (credit-service uses service role)
  - Dynamic API routes using cookies show expected warning during build but still work correctly at runtime
  - dev-browser skill not available in this workspace; browser verification skipped
---
