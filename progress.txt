# Ralph Progress Log
Started: Wed 14 Jan 2026 20:29:18 +04

## Codebase Patterns
- Use `npm run type-check` (not `typecheck`) for TypeScript checking
- Migrations go in `/lib/supabase/migrations/` with sequential numbering (001, 002, etc.)
- Use `IF NOT EXISTS` for CREATE TABLE to ensure idempotency
- Use `DROP TRIGGER IF EXISTS` before CREATE TRIGGER for idempotency
- Use `CREATE INDEX IF NOT EXISTS` for idempotent index creation
- Use `DROP POLICY IF EXISTS` before CREATE POLICY for idempotent RLS policies
- RLS on child tables: use `EXISTS (SELECT 1 FROM parent WHERE parent.user_id = auth.uid())`
- Service role access: `auth.jwt() ->> 'role' = 'service_role'`
- Pre-existing typecheck errors in test files - not blocking for SQL migrations
---

## 2026-01-14 16:30 - US-001
Thread: https://ampcode.com/threads/T-019bbd57-1602-765b-bd13-f12132dba7f4
- Created accountability_investigations table in migration 013
- Includes all columns: id, user_id, target_entity, entity_type, ethics_acknowledged_at, profile_data, corruption_scenarios, action_items, quality_score, quality_notes, generation_time_ms, data_sources_count, is_public, created_at, updated_at
- Added CHECK constraint for entity_type (individual/organization)
- Added CHECK constraint for quality_score (0-10)
- Created updated_at trigger function
- Files changed: lib/supabase/migrations/013_add_accountability_tracker_tables.sql
- **Learnings for future iterations:**
  - Pre-existing typecheck errors in test files - not blocking for SQL migrations
  - Pattern: Use `gen_random_uuid()` for UUID primary keys
  - Pattern: Use `TIMESTAMPTZ` for all timestamp columns (not TIMESTAMP)
---

## 2026-01-14 16:45 - US-002
Thread: https://ampcode.com/threads/T-019bbd58-ab5b-74b9-a746-970d47d81810
- Created accountability_investigation_sources table in migration 013
- Includes all columns: id, investigation_id (FK with CASCADE), source_type, url, title, accessed_at, data_extracted, verification_status, created_at
- Added CHECK constraint for source_type (companies_house, charity_commission, register_of_interests, electoral_commission, contracts_finder, web_search, gov_uk, other)
- Added CHECK constraint for verification_status (verified, unverified, disputed)
- Files changed: lib/supabase/migrations/013_add_accountability_tracker_tables.sql
- **Learnings for future iterations:**
  - Pattern: Use foreign key with `ON DELETE CASCADE` for child tables referencing parent tables
---

## 2026-01-14 17:00 - US-003
Thread: https://ampcode.com/threads/T-019bbd5a-1ced-7258-9365-9716e6c1d26d
- Added 6 indexes to accountability tables in migration 013
- accountability_investigations: user_id, created_at DESC, target_entity, quality_score (partial WHERE NOT NULL)
- accountability_investigation_sources: investigation_id, source_type
- Files changed: lib/supabase/migrations/013_add_accountability_tracker_tables.sql
- **Learnings for future iterations:**
  - Pattern: Use `CREATE INDEX IF NOT EXISTS` for idempotency
  - Pattern: Use partial indexes (`WHERE column IS NOT NULL`) for nullable columns to save space
  - Pattern: Use DESC for timestamp columns commonly sorted newest-first
---

## 2026-01-14 17:15 - US-004
Thread: https://ampcode.com/threads/T-019bbd5b-bd6d-71d0-ac04-102c77d9cfcb
- Added Row Level Security policies to accountability tables
- Enabled RLS on both accountability_investigations and accountability_investigation_sources
- Users can SELECT/INSERT/UPDATE their own investigations (auth.uid() = user_id)
- Service role has full access to both tables (auth.jwt() ->> 'role' = 'service_role')
- Sources access controlled via subquery on parent investigation
- Files changed: lib/supabase/migrations/013_add_accountability_tracker_tables.sql
- **Learnings for future iterations:**
  - Pattern: Use `DROP POLICY IF EXISTS` before CREATE POLICY for idempotency
  - Pattern: Use subquery EXISTS for RLS on child tables (e.g., sources checking parent investigation ownership)
  - Pattern: Service role access uses `auth.jwt() ->> 'role' = 'service_role'`
---

## 2026-01-14 20:30 - US-005
Thread: https://ampcode.com/threads/T-019bbd5d-3f06-72eb-b72d-f2c3362fb22e
- Created /lib/types/accountability.ts with core TypeScript types
- Exported EntityType union type for individual/organization
- Exported Position, CompanyRecord, InterestDeclaration, CharityRecord, Donation, Contract interfaces
- All interfaces include required sourceUrl field for audit trail
- Files changed: lib/types/accountability.ts
- **Learnings for future iterations:**
  - Pattern: Follow existing types file conventions (see lib/types/brief.ts for examples)
  - Pattern: Use string for dates in interfaces (ISO format), number for monetary values
  - Pattern: Include sourceUrl on all record types for traceability
---

## 2026-01-14 21:00 - US-006
Thread: https://ampcode.com/threads/T-019bbd5e-e7bb-74d9-b564-e06919e9b49f
- Added UKProfileData and scenario types to /lib/types/accountability.ts
- Exported ConflictOfInterest with conflictType (financial/regulatory/oversight/personal)
- Exported HistoricalCase with name, year, description, outcome, sourceUrl
- Exported SourceType union and VerificationStatus type
- Exported InvestigationSource interface for tracking data sources
- Exported UKProfileData with all profile fields and dataCompleteness object
- Exported CorruptionScenario with riskLevel, detectionDifficulty, historicalPrecedents
- Exported ActionItem with priority (1|2|3) and relatedScenarios array
- Files changed: lib/types/accountability.ts
- **Learnings for future iterations:**
  - Pattern: Use helper types (e.g., ConflictType, RiskLevel) before using in interfaces for reusability
  - Pattern: Use numeric year for HistoricalCase (more precise than date string)
---

## 2026-01-14 21:30 - US-007
Thread: https://ampcode.com/threads/T-019bbd60-4336-750e-9032-a8bd76a5acd5
- Added database row types to /lib/types/accountability.ts
- Exported AccountabilityInvestigation interface matching all DB columns
- Exported AccountabilityInvestigationSource interface for sources table
- Exported CreateInvestigationInput type for service function input
- Exported UpdateInvestigationInput type for partial updates (profile_data, corruption_scenarios, action_items, quality_score, quality_notes, generation_time_ms, data_sources_count)
- Files changed: lib/types/accountability.ts
- **Learnings for future iterations:**
  - Pattern: Use `| null` for nullable DB columns (e.g., quality_score, quality_notes)
  - Pattern: Use Date type in input interfaces, string type in DB row interfaces (Supabase returns ISO strings)
  - Pattern: Use Record<string, unknown> for JSONB columns with unstructured data (e.g., data_extracted)
---

## 2026-01-14 22:00 - US-008
Thread: https://ampcode.com/threads/T-019bbd61-eeea-71ba-aef3-38b451dd9285
- Created /lib/services/accountability-service.ts with createInvestigation function
- Function accepts targetEntity, userId, entityType, ethicsAcknowledgedAt parameters
- Returns { id: string } with the new investigation ID
- Uses getSupabaseClient() pattern from brief-service.ts
- Includes JSDoc comment with @param and @returns
- Files changed: lib/services/accountability-service.ts
- **Learnings for future iterations:**
  - Pattern: Follow brief-service.ts for service function conventions
  - Pattern: Use `(supabase.from("table") as any)` to avoid strict typing issues
  - Pattern: Convert Date to ISO string with .toISOString() for DB insert
---
