# Ralph Progress Log
Started: Sun 11 Jan 2026 22:25:49 +04

## Codebase Patterns
- Use `npm run build` to typecheck the project
- Vercel KV uses `kv` export from `/lib/cache/kv-client.ts` with automatic fallback to in-memory
- Cache key format convention: `{resource}:{id}` e.g., `brief:abc123`
- Use `(supabase.from("table") as any).update()` for Supabase updates due to type inference issues
- SWR: Import `useSWR` from 'swr'; provider in layout.tsx provides default fetcher
- SWR FetchError: Check `error.status === 404` for not found handling
- Supabase error 22P02: Invalid UUID format - treat as "not found" alongside PGRST116
- Brief page: Database briefs may have empty/null fields for structured_data, narrative, etc. - use defensive access
- Use `createBrief(briefData)` from brief-service.ts to create briefs with automatic cache warming
- Use `withRetry(async () => {...})` from /lib/supabase/client.ts for database ops that may have connection issues

---

## Sun 11 Jan 2026 - US-001
Thread: https://ampcode.com/threads/T-019bae4e-ae00-73d7-bded-6c3376816c72
- Installed @vercel/kv, tailwindcss-animate, @supabase/ssr packages
- Created /lib/cache/kv-client.ts with KVClient interface, VercelKVClient, and InMemoryKV fallback
- Added KV_REST_API_URL and KV_REST_API_TOKEN to .env.example
- Documented Vercel KV setup in SETUP.md (Step 5)
- Fixed pre-existing type errors in app/brief/[id]/page.tsx (implicit any types)
- **Learnings for future iterations:**
  - The npm install may remove existing packages; always run `npm install` after adding new packages
  - Main branch has some pre-existing type errors that need fixing
  - Use explicit type annotations in .map() callbacks when dealing with `any` typed objects
---

## Sun 11 Jan 2026 - US-002
Thread: https://ampcode.com/threads/T-019bae54-24f7-76e8-b9cc-fcd76b72026c
- Created /lib/cache/with-cache.ts with generic withCache<T> function
- Function checks cache first, executes fn on miss, stores result with TTL
- Logs cache hits/misses with [Cache] HIT/MISS prefix
- Handles cache read/write errors gracefully (logs and proceeds with direct fetch)
- **Learnings for future iterations:**
  - Use `withCache(key, fn, ttlSeconds)` pattern to wrap any async operation
  - Cache errors are logged but never block the main operation
---

## Sun 11 Jan 2026 - US-003
Thread: https://ampcode.com/threads/T-019bae55-50ee-7206-b48b-b8bb74a66687
- Created /lib/cache/invalidate.ts with invalidateCache and invalidatePattern functions
- invalidateCache(key) deletes a single key and logs the event
- invalidatePattern(pattern) finds keys matching pattern and deletes them all
- All errors are caught and logged, never thrown (consistent with with-cache.ts)
- **Learnings for future iterations:**
  - Use `invalidateCache('brief:${id}')` to clear a specific brief cache
  - Use `invalidatePattern('brief:*')` to clear all brief caches
---

## Sun 11 Jan 2026 - US-004
Thread: https://ampcode.com/threads/T-019bae5c-8c0b-76ad-9396-b3fe5e68026d
- Created /lib/services/brief-service.ts with getBriefById function
- Uses withCache wrapper with key format `brief:{id}` and 300 second TTL
- Fetches from Supabase using createServiceRoleClient
- Returns null for not found (PGRST116 error), throws for other errors
- **Learnings for future iterations:**
  - lib/services directory did not exist; created it for this story
  - Use `createServiceRoleClient()` for server-side data fetching that bypasses RLS
  - PGRST116 is the Supabase error code for "no rows found"
---

## Sun 11 Jan 2026 - US-005
Thread: https://ampcode.com/threads/T-019bae5e-e328-7158-a40c-4a786c7e1158
- Added updateBriefFromState and updateBriefClassification functions to /lib/services/brief-service.ts
- Both functions call invalidateCache for the specific brief and "briefs:popular" key after successful update
- Used `as any` cast on supabase.from("briefs") to work around Database type inference issue
- **Learnings for future iterations:**
  - Supabase's typed client may infer `never` for .update() if Database types are incomplete
  - Use `(supabase.from("table") as any).update()` pattern to work around strict types
  - Always invalidate both specific cache key and related collection caches (e.g., `briefs:popular`)
---

## Sun 11 Jan 2026 - US-006
Thread: https://ampcode.com/threads/T-019bae66-6ec8-723d-9df1-39662742c0a5
- Verified /app/api/briefs/[id]/route.ts GET endpoint was already implemented
- Fetches brief using getBriefById from brief-service (uses withCache)
- Returns 404 JSON response if brief not found
- Sets Cache-Control: public, s-maxage=60, stale-while-revalidate=300
- Sets ETag header based on brief.updated_at timestamp
- Returns 304 Not Modified when If-None-Match matches ETag
- Typecheck passes
- **Learnings for future iterations:**
  - Next.js 14+ uses `params: Promise<{ id: string }>` for dynamic route params (must await)
  - ETag comparison uses exact string match of `"${updated_at}"`
---

## Sun 11 Jan 2026 - US-007
Thread: https://ampcode.com/threads/T-019bae68-5aaa-7607-9ead-35b52d9b9b52
- Added getPopularBriefs function to /lib/services/brief-service.ts
- Orders by clarity_score DESC (nulls last), then created_at DESC as secondary sort
- Uses withCache with key "briefs:popular" and 600 second TTL
- Created /app/api/briefs/popular/route.ts endpoint
- Sets Cache-Control: public, s-maxage=300, stale-while-revalidate=600
- **Learnings for future iterations:**
  - briefs table has no view_count or upvotes column; clarity_score is used as popularity proxy
  - Use double .order() calls for primary and secondary sort ordering
---

## Sun 11 Jan 2026 - US-008
Thread: https://ampcode.com/threads/T-019bae6a-7162-7599-9e34-d45a2679be73
- Installed swr package
- Created /lib/swr/fetcher.ts with FetchError class and generic fetcher<T> function
- Created /lib/swr/config.ts with global SWR configuration (revalidateOnFocus, errorRetry, etc.)
- Created /lib/swr/provider.tsx client component wrapper for SWRConfig
- Updated app/layout.tsx to wrap children in SWRProvider
- **Learnings for future iterations:**
  - SWRConfig must be in a client component ("use client") since it uses React context
  - FetchError class exposes status code for proper 404/error handling in useSWR consumers
  - Use `useSWR<T>('/api/endpoint')` with the provider's default fetcher
---

## Sun 11 Jan 2026 - US-009
Thread: https://ampcode.com/threads/T-019bae6c-a7d8-707a-93d0-7906ca887302
- Rewrote /app/brief/[id]/page.tsx to use useSWR for data fetching
- Added BriefSkeleton component for loading state
- Added NotFoundError component for 404 handling (when error.status === 404)
- Added ErrorMessage component for generic errors
- Made Brief interface fields optional to handle database briefs with null/empty content
- Updated brief-service to treat 22P02 (invalid UUID) as not found
- Defensive rendering: definitions, factors, policies, consequences, sources all check length before rendering
- **Learnings for future iterations:**
  - Database briefs may not have sources array - check structured_data.sources or metadata.sources
  - Optional chaining and ?? [] pattern for defensive array access
  - SWR skeleton must render same page structure without the actual data for smooth transitions
---

## Sun 11 Jan 2026 - US-010
Thread: https://ampcode.com/threads/T-019bae78-4588-767b-ad95-862c57b750dc
- Added warmBriefCache(briefId) function to /lib/services/brief-service.ts
- warmBriefCache calls getBriefById to populate cache and logs warming events
- Added createBrief function that inserts brief, warms cache, and invalidates popular briefs
- Both functions provide clear console logging with [Cache Warming] prefix
- **Learnings for future iterations:**
  - Brief generation pipeline is not yet fully implemented - createBrief is the integration point
  - Use `createBrief(briefData)` from generation code to automatically warm cache
  - warmBriefCache can also be called standalone after any brief update if cache invalidation was skipped
---

## Sun 11 Jan 2026 - US-011
Thread: https://ampcode.com/threads/T-019bae83-59a9-7625-b949-d297eb5b6272
- Verified /app/api/admin/cache-flush/route.ts POST endpoint already exists and is complete
- Uses withAdmin middleware for admin authentication
- Accepts optional { pattern } body for selective flush; flushes all if empty
- Returns JSON with success, message, keysCleared, flushedBy, and timestamp
- Logs flush event with admin user email and ID
- Typecheck passes
- **Learnings for future iterations:**
  - Previous iterations already implemented this feature - always verify before building
  - withAdmin middleware checks user.role === "admin" OR user.email in ADMIN_EMAILS env var
---

## Sun 11 Jan 2026 - US-012
Thread: https://ampcode.com/threads/T-019bae84-feb0-767a-8f39-e2addd955d54
- Implemented singleton pattern for createServiceRoleClient() in /lib/supabase/client.ts
- Added withRetry<T>() utility for database operations with exponential backoff (3 retries)
- Updated all brief-service.ts database operations to use withRetry wrapper
- Retry logic handles network errors: fetch failed, ECONNREFUSED, ETIMEDOUT, socket hang up
- **Learnings for future iterations:**
  - Use `withRetry(async () => { ... })` to wrap any Supabase operation that may have connection issues
  - Singleton pattern uses module-level variable `serviceRoleClientInstance`
  - Retry only applies to connection errors, not application errors (PGRST116 is not retried)
---
