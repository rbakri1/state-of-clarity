# Ralph Progress Log
Started: Fri  9 Jan 2026 20:30:01 +04

## Codebase Patterns
- When adding map callbacks in TSX, always add type annotations (e.g., `(item: any, i: number)`) to avoid implicit any errors
- Missing `@supabase/ssr` package - install it if needed for server-side Supabase client
- Agents live in `/lib/agents/` directory
- Types should be organized in `/lib/types/` directory
- Migrations go in `/lib/supabase/migrations/` directory - use `IF NOT EXISTS` for idempotent migrations
- Database types are defined in `/lib/supabase/client.ts` Database interface - update Row, Insert, and Update for new columns
- LangGraph: Use chained `.addNode().addEdge()` calls for proper TypeScript type inference - separate calls cause type errors

---

## 2026-01-09 - US-001
Thread: https://ampcode.com/threads/T-019ba397-f2e7-715b-b16f-06aed11c6102
- Created `/lib/types/classification.ts` with all classification taxonomy types
- Files changed: lib/types/classification.ts (new)
- **Learnings for future iterations:**
  - Types directory created at `/lib/types/` for shared type definitions
  - Classification types: Domain (11 values), ControversyLevel (3), QuestionType (4), TemporalScope (4)
---

## 2026-01-09 - US-002
Thread: https://ampcode.com/threads/T-019ba399-7ada-771e-a0f7-9ba0b8fa3dff
- Created `/lib/agents/question-classifier.ts` with `classifyQuestion()` function
- Uses Claude Haiku (claude-3-5-haiku-20241022) for cost efficiency
- Prompt includes 10 diverse examples covering all domain categories
- Validation functions ensure type safety even if Claude returns unexpected values
- Files changed: lib/agents/question-classifier.ts (new)
- **Learnings for future iterations:**
  - Follow existing agent pattern from research-agent.ts: use Anthropic SDK, extract JSON from response
  - Always validate LLM responses with fallback defaults for robustness
  - Use `{{PLACEHOLDER}}` template pattern in prompts for string substitution
---

## 2026-01-09 - US-003
Thread: https://ampcode.com/threads/T-019ba39c-10a8-735c-ae6c-9fd7017aa13f
- Created `test-question-classifier.ts` with 14 diverse test cases
- Tests cover: domain classification (5 questions), controversy levels (3 tests), question types (3 tests), temporal scopes (3 tests)
- All tests pass successfully
- Files changed: test-question-classifier.ts (new)
- **Learnings for future iterations:**
  - Follow test script pattern from test-research-agent.ts: load .env.local with dotenv, run with `npx tsx`
  - LLM classifications may vary slightly - test for critical fields, allow flexibility on edge cases
  - Classifier correctly handles: EU=high controversy, 4-day week=medium, factual defs=low
---

## 2026-01-09 - US-004
Thread: https://ampcode.com/threads/T-019ba39f-2e79-7413-a8d7-8d319908e5fb
- Added `classification` JSONB column to briefs table in schema.sql
- Updated Database interface in client.ts with classification field in Row, Insert, and Update types
- Created migration file: `/lib/supabase/migrations/001_add_classification_column.sql`
- Files changed: lib/supabase/schema.sql, lib/supabase/client.ts, lib/supabase/migrations/001_add_classification_column.sql (new)
- **Learnings for future iterations:**
  - Migrations directory created at `/lib/supabase/migrations/` for database migrations
  - Use `ADD COLUMN IF NOT EXISTS` for idempotent migrations that can be run multiple times safely
  - When adding new columns, update all three places in Database interface: Row, Insert, Update
  - Installed missing `tailwindcss-animate` dependency that was blocking builds
---

## 2026-01-09 - US-005
Thread: https://ampcode.com/threads/T-019ba3a1-c42c-77dd-81eb-27acf81517a8
- Created `/lib/agents/specialist-personas.ts` with 10 domain-specific agent personas
- Each persona includes: name, domain, expertise, systemPrompt, keyConsiderations, preferredSources
- Personas cover all 11 Domain types (economics, healthcare, climate, education, defense, immigration, housing, justice, technology, governance, other)
- Exported `getSpecialistPersona(domain: Domain)` and `getAllPersonas()` functions
- Files changed: lib/agents/specialist-personas.ts (new)
- **Learnings for future iterations:**
  - Specialist personas are mapped directly from Domain types in classification.ts
  - Each persona includes UK-specific sources (e.g., ONS, NHS, IFS) as preferred sources
  - The 'other' domain uses a generalist persona for cross-cutting topics
---

## 2026-01-09 - US-006
Thread: https://ampcode.com/threads/T-019ba3a3-daaf-709c-ba02-cdabb2e963bf
- Added `agent_execution_logs` table to schema.sql with columns: id, brief_id, agent_name, started_at, completed_at, duration_ms, status, error_message, metadata (JSONB)
- Created migration: `/lib/supabase/migrations/002_add_agent_execution_logs_table.sql`
- Updated Database interface in client.ts with Row, Insert, Update types for agent_execution_logs
- Added indexes on brief_id and started_at
- Added RLS policies for public read and system write access
- Fixed pre-existing typecheck errors in app/brief/[id]/page.tsx (added type annotations to map callbacks)
- Installed missing `@supabase/ssr` dependency
- Files changed: lib/supabase/schema.sql, lib/supabase/client.ts, lib/supabase/migrations/002_add_agent_execution_logs_table.sql (new), app/brief/[id]/page.tsx, package.json
- **Learnings for future iterations:**
  - Always add type annotations to map callbacks in TSX (e.g., `(item: any, i: number)`) to avoid implicit any errors
  - Install `@supabase/ssr` if it's missing for server-side client functionality
  - Migration uses `IF NOT EXISTS` patterns for idempotent execution
---

## 2026-01-09 - US-007
Thread: https://ampcode.com/threads/T-019ba3a9-fb52-70ba-b445-4e9b141b33c2
- Created `/lib/agents/summary-prompts.ts` with 4 reading level prompts
- Child: 100-150 words, simple vocabulary, uses analogies, no jargon
- Teen: 200-250 words, accessible with defined key terms
- Undergrad: 350-400 words, academic vocabulary, cites sources
- Postdoc: 450-500 words, technical depth, methodological nuance
- Each prompt includes complete example output for reference
- Exported: `getSummaryPrompt(level)`, `getAllSummaryPrompts()`, `getAllReadingLevels()`
- Files changed: lib/agents/summary-prompts.ts (new)
- **Learnings for future iterations:**
  - Summary prompts follow same pattern as specialist-personas.ts: interface, const objects, map, getter functions
  - ReadingLevel type: 'child' | 'teen' | 'undergrad' | 'postdoc'
  - Each SummaryPrompt includes: level, name, targetAudience, wordCount (min/max), systemPrompt, exampleOutput
---

## 2026-01-09 - US-008
Thread: https://ampcode.com/threads/T-019ba3ac-5220-727d-9167-5488332ab21a
- Created `/lib/agents/retry-wrapper.ts` with exponential backoff retry logic
- Implemented `withRetry()` function: 3 attempts with 1s, 2s, 4s delays
- Implemented `wrapWithRetry()` to create wrapped agent functions with built-in retry
- Created `AgentRetryError` custom error class with aggregated error tracking
- Added `withSmartRetry()` that only retries on transient errors (429, 5xx, network errors)
- Added `isRetryableError()` helper to distinguish transient vs permanent failures
- All retry attempts logged with error details, agent name, and attempt count
- Files changed: lib/agents/retry-wrapper.ts (new)
- **Learnings for future iterations:**
  - Use `withRetry()` for simple retry, `wrapWithRetry()` to pre-wrap agent functions
  - Exponential backoff formula: `initialDelayMs * (backoffMultiplier ^ (attempt - 1))`
  - `AgentRetryError` collects all errors from all attempts for debugging
---

## 2026-01-09 - US-009
Thread: https://ampcode.com/threads/T-019ba3ae-6089-7229-bc3b-dce94681dc40
- Created `/lib/agents/execution-logger.ts` with comprehensive logging utilities
- Functions: `logAgentStart`, `logAgentComplete`, `logAgentFailed`, `withExecutionLogging`, `executeWithLogging`
- Includes `estimateTokenCount()` for input/output size estimation (~4 chars per token)
- Supports `ExecutionMode`: 'parallel' | 'sequential' and `parallelGroup` for grouping parallel agents
- Includes `getExecutionLogsForBrief()` and `getBriefPerformanceSummary()` for retrieving logs
- All database operations are async and non-blocking (fire-and-forget pattern)
- Uses `as any` type assertions for Supabase queries on agent_execution_logs table (type inference issues)
- Files changed: lib/agents/execution-logger.ts (new)
- **Learnings for future iterations:**
  - Supabase type inference may fail for new tables - use `as any` on `.from('table')` if needed
  - Pattern: `(supabase.from('table') as any).insert(...)`
  - For map callbacks on Supabase data, add type annotation: `(row: any) =>`
  - Non-blocking logging uses `.catch(() => {})` to prevent unhandled rejections
---

## 2026-01-09 - US-010
Thread: https://ampcode.com/threads/T-019ba43c-9b17-7485-b4de-4cbaf39d2459
- Created `/lib/agents/langgraph-orchestrator.ts` with full pipeline orchestration
- Implemented LangGraph StateGraph with parallel execution using chained `.addNode()` and `.addEdge()` calls
- Pipeline: Research → Classification → [Structure || Narrative] → Reconciliation → [4x Summary] → Clarity Scoring
- Parallel branches for Structure/Narrative (merge at Reconciliation) and 4 Summary agents (merge at Clarity Scoring)
- Integrated retry wrapper (`withRetry`) and execution logger (`executeWithLogging`) for all agents
- Defined comprehensive state with `Annotation.Root` including sources, classification, persona, structure, narrative, summaries, clarityScore
- Created agent placeholder functions: `generateStructure`, `generateNarrative`, `reconcileOutputs`, `generateSummary`, `scoreClarityInternal`
- Files changed: lib/agents/langgraph-orchestrator.ts (new)
- **Learnings for future iterations:**
  - LangGraph TypeScript requires chained `.addNode().addEdge()` calls for proper type inference - separate `graph.addEdge()` calls cause type errors
  - Use `Annotation.Root({...})` for state schema with `Annotation<T>({ reducer, default })` for each field
  - Parallel execution works by adding multiple edges from the same source node (e.g., classification → structure AND classification → narrative)
  - LangGraph automatically handles fan-in by waiting for all parallel branches before proceeding
  - Import `StateGraph, Annotation, END, START` from "@langchain/langgraph"
---

## 2026-01-09 - US-011
Thread: https://ampcode.com/threads/T-019ba440-a501-76bb-a363-d447d46a0d41
- Verified and enhanced parallel Structure and Narrative agent execution
- Structure and Narrative agents already run simultaneously via LangGraph parallel edges
- Both agents receive same research sources via `state.sources`
- Both agents use specialist persona from classification via `state.persona`
- Added explicit timing logs for parallel execution visibility
- Files changed: lib/agents/langgraph-orchestrator.ts (enhanced logging)
- **Learnings for future iterations:**
  - LangGraph parallel execution: adding multiple edges from same source node causes parallel execution
  - The parallel execution was already implemented in US-010 - just needed timing logs for observability
  - Use `Date.now()` for inline timing measurements in node functions
---

## 2026-01-09 - US-012
Thread: https://ampcode.com/threads/T-019ba442-ded3-7638-a9fe-5b7ec0c8fdbb
- Created `/lib/agents/reconciliation-agent.ts` as dedicated module
- Agent receives Structure + Narrative inputs and performs 5 consistency checks
- Returns ReconciliationOutput with: reconciledNarrative, changes array, isConsistent boolean
- Structure is treated as source of truth - Narrative is adjusted to align
- Uses Claude Haiku for fast execution (<10 seconds)
- Updated orchestrator to import from new module
- Files changed: lib/agents/reconciliation-agent.ts (new), lib/agents/langgraph-orchestrator.ts (updated import)
- **Learnings for future iterations:**
  - Follow pattern: export dedicated interface types (ReconciliationInput, ReconciliationOutput)
  - Validation functions ensure robustness even if LLM response is malformed
  - Prompt instructs minimal changes to avoid unnecessary rewrites
---
