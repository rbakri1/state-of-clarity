# Ralph Progress Log
Started: Wed 14 Jan 2026 21:28:27 +04

## Codebase Patterns
- Services go in `/lib/services/` with JSDoc comments on all exported functions
- Use types from `/lib/types/accountability.ts` for accountability features
- Handle 404 responses gracefully by returning empty arrays (not throwing)
- Implement retry logic with exponential backoff (1s/2s/4s delays, 3 attempts)
- Use `verificationStatus: "verified"` for official API sources, `"unverified"` for web scraped data

---

## 2026-01-14 21:30 - US-001
Thread: https://ampcode.com/threads/T-019bbd8d-3be0-707c-bf81-b961cf91c967
- Created Companies House API service file at `/lib/services/companies-house-api.ts`
- Added COMPANIES_HOUSE_API_KEY to .env.example
- Implemented:
  - `getCompaniesHouseAuthHeader()` - Basic Auth header generation
  - `searchOfficers(name)` - Search officers endpoint
  - `getOfficerAppointments(officerId)` - Get appointments for an officer
  - `fetchCompaniesHouseProfile(entityName)` - Full profile with retry logic
- All functions have JSDoc comments
- 404 responses return empty arrays (graceful handling)
- **Learnings for future iterations:**
  - Pre-existing test errors in `__tests__/` directory - not blocking commits
  - Types `CompanyRecord` and `InvestigationSource` already defined in accountability.ts
  - Companies House API uses Basic Auth with API key as username and empty password
---

## 2026-01-14 21:32 - US-002
Thread: https://ampcode.com/threads/T-019bbd8f-6ea9-749c-9e2e-c8902203291f
- US-002 was already implemented as part of US-001 commit
- `fetchCompaniesHouseProfile(entityName)` function verified at lines 144-237 in companies-house-api.ts
- Returns `{ records: CompanyRecord[]; sources: InvestigationSource[] }`
- Has retry logic with exponential backoff (3 attempts, 1s/2s/4s delays)
- Creates sources with `sourceType: "companies_house"` and `verificationStatus: "verified"`
- Typecheck passes
---

## 2026-01-14 21:35 - US-003
Thread: https://ampcode.com/threads/T-019bbd8f-6ea9-749c-9e2e-c8902203291f
- Created `/lib/parsers/charity-commission-parser.ts`
- Implemented `fetchCharityCommissionData(entityName)` function
- Uses Tavily search with query: `"[name]" trustee site:register-of-charities.charitycommission.gov.uk`
- Parses charity numbers from URLs using regId and /charity/ patterns
- Returns `{ records: CharityRecord[]; sources: InvestigationSource[] }`
- Sources have `verificationStatus: "unverified"` (web scraped data)
- Typecheck passes
- **Learnings for future iterations:**
  - Created `/lib/parsers/` directory for Tavily-based parsers
  - Tavily pattern: use `safeAICall` wrapper for error handling
  - Use `include_domains` param to limit search to specific sites
---

## 2026-01-14 21:34 - US-004
Thread: https://ampcode.com/threads/T-019bbd91-fe11-75ad-8463-f3eb956e2bf3
- Created `/lib/parsers/parliament-parser.ts`
- Implemented `fetchRegisterOfInterests(entityName)` function
- Uses Tavily search with query: `"[name]" "register of interests" site:parliament.uk`
- Parses interest categories: Employment, Donations, Land, Shareholdings
- Extracts monetary values with £ symbol patterns
- Returns `{ records: InterestDeclaration[]; sources: InvestigationSource[] }`
- Sources have `verificationStatus: "unverified"` (web scraped data)
- Returns empty arrays if no results (graceful handling for non-MPs)
- Typecheck passes
- **Learnings for future iterations:**
  - Use typed category literals (e.g., `type InterestCategory = "Employment" | ...`) for type safety
  - Extract dates from content with regex, fallback to current date
  - Deduplicate results using `Set<string>` on URLs
---

## 2026-01-14 21:40 - US-005
Thread: https://ampcode.com/threads/T-019bbd93-a976-76bb-8a2f-a86d8cee5ec3
- Created `/lib/parsers/electoral-commission-parser.ts`
- Implemented `fetchElectoralCommissionData(entityName)` function
- Uses Tavily search with query: `"[name]" donations site:search.electoralcommission.org.uk`
- Extracts £ amounts using regex `/£([\d,]+(?:\.\d{2})?)/g`
- Returns `{ records: Donation[]; sources: InvestigationSource[] }`
- Parses donation types (Cash, Services, Sponsorship, Loan)
- Extracts donor/recipient context from content
- Sources have `verificationStatus: "unverified"` (web scraped data)
- Typecheck passes
- **Learnings for future iterations:**
  - Extract multiple amounts per result (loop through regex matches)
  - Donation type can be inferred from keywords: cash, services, sponsorship, loan
  - Donor/recipient direction can be inferred from context words like "donated to" or "received from"
---

## 2026-01-14 21:45 - US-006
Thread: https://ampcode.com/threads/T-019bbd95-59bf-77b5-93fe-1980ac2e6d53
- Created `/lib/parsers/contracts-finder-parser.ts`
- Implemented `fetchGovernmentContracts(entityName)` function
- Uses Tavily search with query: `"[name]" site:contractsfinder.service.gov.uk`
- Extracts contract values supporting £m, £bn, and standard amounts
- Returns `{ records: Contract[]; sources: InvestigationSource[] }`
- Maps to Contract type with: contractTitle, buyer, supplier, value, awardDate, sourceUrl
- Sources have `verificationStatus: "unverified"` (web scraped data)
- Typecheck passes (no errors specific to this file)
- **Learnings for future iterations:**
  - Contract type requires: contractTitle, buyer, supplier, value, awardDate, sourceUrl
  - Value extraction should handle £m/million and £bn/billion suffixes
  - Government department names can be matched from a curated list or extracted from "awarded by" patterns
---

## 2026-01-14 21:50 - US-007
Thread: https://ampcode.com/threads/T-019bbd97-50e4-773b-9b8b-63301a942449
- Created `/lib/services/uk-public-data-service.ts`
- Implemented `fetchUKPublicData(targetEntity, entityType)` orchestrator
- Defined types: `UKPublicDataResult`, `DataSourceError`, `PartialUKProfileData`
- Calls all 5 data sources in parallel using `Promise.all` with safe wrappers
- Each source wrapped in try-catch via `safeDataSourceCall` for graceful degradation
- Aggregates results from all sources into single `profileData` object
- Collects all sources and errors arrays
- Implements `isRecoverableError` to classify transient vs permanent errors
- Skips Contracts Finder for individuals (logs skip reason)
- Typecheck passes
- **Learnings for future iterations:**
  - Use wrapper function pattern for graceful degradation instead of dynamic fetcher arrays (avoids TypeScript union type issues)
  - `Promise.all` with explicit typed promises is cleaner than `Promise.allSettled` with generic handlers
  - Pre-existing test errors in `__tests__/` don't block commits
---

## 2026-01-14 22:10 - US-008
Thread: https://ampcode.com/threads/T-019bbd99-7de8-763f-a0e0-6724533522db
- Added caching to UK public data service orchestrator
- Used existing `withCache` utility from `/lib/cache/with-cache.ts`
- Cache key format: `uk_data:{source}:{normalized_entity_name}`
- Implemented TTLs per spec:
  - Companies House: 24hrs (86400s)
  - Charity Commission: 24hrs (86400s)
  - Register of Interests: 12hrs (43200s)
  - Electoral Commission: 12hrs (43200s)
  - Contracts Finder: 24hrs (86400s)
- Cache hit/miss logging done by withCache utility automatically
- Typecheck passes (pre-existing test errors not related to this change)
- **Learnings for future iterations:**
  - `withCache` already logs hits/misses via console.log `[Cache] HIT/MISS: {key}`
  - Normalize cache keys by lowercasing, trimming, and replacing spaces with underscores
  - Cache wrapper goes inside `safeDataSourceCall` fetcher function
---

## 2026-01-14 23:05 - US-009
Thread: https://ampcode.com/threads/T-019bbd9b-68d8-701c-bea0-e9a3332e6e40
- Added Sentry error logging to UK public data service
- Imported `@sentry/nextjs` in uk-public-data-service.ts
- Updated `safeDataSourceCall` to log errors with:
  - Tags: component 'uk-public-data', source name, normalized entity name
  - Extra: entityType, errorType (transient/permanent), entityName, recoverable
- Added `getErrorType()` helper function to classify transient vs permanent errors
- Transient errors (timeout, 500, 502, 503, network issues) marked `recoverable: true`
- Permanent errors (404, 401, 403) marked `recoverable: false`
- Typecheck passes (pre-existing test errors not related to this change)
- **Learnings for future iterations:**
  - Use `@sentry/nextjs` for Sentry imports (consistent with other files)
  - Tags are indexed for filtering, Extra is for additional context
  - Pass entity context through wrapper functions for proper error tagging
---

## 2026-01-14 23:08 - US-010
Thread: https://ampcode.com/threads/T-019bbd9b-68d8-701c-bea0-e9a3332e6e40
- US-010 was already implemented as part of US-007 commit
- Verified in uk-public-data-service.ts lines 231-251:
  - `entityType === "organization"` check before calling fetchGovernmentContracts
  - Sets `governmentContracts` to empty array for individuals
  - Logs "Skipping Contracts Finder for individual entity"
- No changes needed
---

## 2026-01-15 01:48 - US-011
Thread: https://ampcode.com/threads/T-019bbd9d-da6b-752c-814d-4a37c54e95b0
- Created `__tests__/unit/services/companies-house-api.test.ts` with 14 tests
- Tests cover:
  - `getCompaniesHouseAuthHeader()` - Basic Auth encoding
  - `searchOfficers()` - parsed results, 404 handling, empty items
  - `getOfficerAppointments()` - appointments fetch, 404 handling, error throws
  - `fetchCompaniesHouseProfile()` - CompanyRecord mapping, sources with verified status
  - Retry logic - triggers on 500, does NOT trigger on 404
  - Graceful degradation when one officer's appointments fail
- All 14 tests pass
- No typecheck errors in this file (pre-existing errors in other test files unrelated)
- **Learnings for future iterations:**
  - Mock `global.fetch` with `vi.fn()` for API tests
  - Use `vi.stubEnv()` for environment variables
  - Reset mocks in `beforeEach` with `vi.clearAllMocks()` and `mockFetch.mockReset()`
---

## 2026-01-15 21:52 - US-012
Thread: https://ampcode.com/threads/T-019bbda0-55c4-76f5-8272-fd4bb8eeb44f
- Created `__tests__/unit/parsers/uk-data-parsers.test.ts` with 31 tests
- Tests cover all 4 Tavily-based parsers:
  - `fetchCharityCommissionData`: charity number parsing (regId + /charity/ URL patterns), deduplication, role extraction
  - `fetchRegisterOfInterests`: interest category parsing (Employment, Donations, Land, Shareholdings), £ value extraction
  - `fetchElectoralCommissionData`: £ amount extraction, donation types (Cash, Services, Sponsorship, Loan)
  - `fetchGovernmentContracts`: contract value extraction (£, £m, £million, £bn), buyer extraction from known departments
- All parsers tested for returning empty arrays on no results and API errors
- All sources verified as `verificationStatus: "unverified"`
- All 31 tests pass
- No typecheck errors in this file (pre-existing errors in other test files unrelated)
- **Learnings for future iterations:**
  - Mock `safeAICall` via `vi.mock("@/lib/ai/safe-ai-call")` for Tavily-based parser tests
  - Return `{ data, error, isAIServiceError }` structure from mocked `safeAICall`
  - All Tavily parsers share same `TavilySearchResponse` structure with `results` array
---

## 2026-01-15 22:04 - US-013
Thread: https://ampcode.com/threads/T-019bbdab-234b-747a-97ee-e5961e1657f1
- Created `__tests__/unit/services/uk-public-data-service.test.ts` with 7 tests
- Tests cover:
  - `fetchUKPublicData` aggregation: verifies results from all 5 sources are combined correctly
  - Graceful degradation: one source fails, others still return data
  - Graceful degradation: all sources fail, returns empty arrays with proper error classification
  - Cache logic: verifies withCache is called with correct keys and TTLs, cached data returned on second call
  - Entity type filtering: organizations include Contracts Finder, individuals do not (skips call + logs)
- All mocks use vi.mock() for data sources, cache wrapper, and Sentry
- Error recovery classification verified: 500/timeout/network are recoverable, 404/401/403 are not
- All 7 tests pass
- No typecheck errors in this file (pre-existing errors in other test files unrelated)
- **Learnings for future iterations:**
  - Use `vi.mocked()` to get typed mock functions from mocked modules
  - Mock `withCache` to execute fetcher directly: `(_key, fn, _ttl) => fn()`
  - InvestigationSource has no `id` field - types in accountability.ts are source of truth
  - Donation uses `donor`/`recipient`/`date`/`type` fields, not `donorName`/`recipientName`/etc.
---
