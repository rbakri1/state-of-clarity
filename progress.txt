# Ralph Progress Log
Started: Sun 11 Jan 2026 10:47:05 +04
---

## Codebase Patterns
- Import Supabase browser client from `@/lib/supabase/browser` for client components
- Import Supabase server client from `@/lib/supabase/client` for server components/API routes
- Import Database types from `@/lib/supabase/types` for type-only imports
- Add explicit types to `.map()` callbacks when working with `any` typed data
- Use `as Record<string, number>` when iterating Object.entries with unknown values

---

## 2026-01-11 - US-001
Thread: https://ampcode.com/threads/T-019babce-f903-716d-ac7f-42555ed5c6ab
- Extended profiles table with preference fields:
  - preferred_reading_level TEXT DEFAULT 'standard'
  - topic_interests TEXT[]
  - location TEXT
  - notification_email_digest BOOLEAN DEFAULT false
  - notification_new_features BOOLEAN DEFAULT true
- Added TypeScript types to Database interface in lib/supabase/client.ts
- Fixed pre-existing type errors in app/brief/[id]/page.tsx (implicit any types)
- Fixed TopicCategoriesGrid import path
- **Files changed:**
  - lib/supabase/schema.sql
  - lib/supabase/client.ts
  - app/brief/[id]/page.tsx (type fixes)
  - app/components/TopicCategoriesGrid.tsx (import fix)
- **Learnings for future iterations:**
  - The briefs object is typed as `any` - map callbacks need explicit type annotations
  - TopicCategoriesGrid was importing from non-existent browser.ts
---

## 2026-01-11 - US-002
Thread: https://ampcode.com/threads/T-019babd4-cfd3-75ba-ae5d-522192a28ea9
- Created sign-in page with magic link functionality at /app/auth/signin/page.tsx
- Features:
  - Email input with client-side validation (empty, format)
  - Send magic link button calls Supabase auth.signInWithOtp()
  - Success message: "Check your email for the login link"
  - Error handling for rate limiting and invalid emails
  - Link to sign-up page
  - Back to home link
- Refactored Supabase client structure:
  - Created lib/supabase/browser.ts for client components (no next/headers import)
  - Created lib/supabase/types.ts for shared Database types
  - Updated lib/supabase/client.ts for server-only usage
  - Updated TopicCategoriesGrid.tsx to use browser.ts
- **Files changed:**
  - app/auth/signin/page.tsx (new)
  - lib/supabase/browser.ts (new)
  - lib/supabase/types.ts (new)
  - lib/supabase/client.ts (refactored)
  - app/components/TopicCategoriesGrid.tsx (import fix)
- **Learnings for future iterations:**
  - Use lib/supabase/browser.ts for client components (no next/headers)
  - Use lib/supabase/client.ts only in server components/API routes
  - Import Database type from lib/supabase/types.ts for type-only imports
---

## 2026-01-11 - US-003
Thread: https://ampcode.com/threads/T-019babd9-43bf-757e-b58d-b2efd880cf42
- Created sign-up page at /app/auth/signup/page.tsx
- Features:
  - Email input (required) with validation
  - Full name input (optional) - passed as user metadata
  - Create account button calls Supabase auth.signInWithOtp() with data
  - Success message: "Check your email to confirm"
  - Error handling for rate limiting and invalid emails
  - Link to sign-in page for existing users
  - Back to home link
- **Files changed:**
  - app/auth/signup/page.tsx (new)
- **Learnings for future iterations:**
  - Use signInWithOtp with `data` option to pass user metadata (e.g., full_name)
  - Follow existing signin page pattern for consistent UX
---

## 2026-01-11 - US-004
Thread: https://ampcode.com/threads/T-019babdb-b3a5-760b-b0d3-37f9e2bc5da8
- Added Google OAuth sign-in to sign-in page
- Features:
  - "Continue with Google" button with official Google logo (SVG)
  - Calls Supabase auth.signInWithOAuth({ provider: 'google' })
  - Redirect URL configured to /auth/callback
  - "Or continue with" divider between magic link and OAuth
  - Loading state with spinner when OAuth is in progress
  - Disabled state for all buttons during any auth operation
- Added Google OAuth setup documentation to SETUP.md (Step 5)
- **Files changed:**
  - app/auth/signin/page.tsx (modified - added Google OAuth button)
  - SETUP.md (modified - added Google OAuth setup instructions)
- **Learnings for future iterations:**
  - Use signInWithOAuth with redirectTo option pointing to /auth/callback
  - Track OAuth loading state separately (isOAuthLoading) to show which provider is loading
  - Google logo SVG can be inlined for consistent rendering
---

## 2026-01-11 - US-005
Thread: https://ampcode.com/threads/T-019babdf-9e81-73dd-a435-2381bbc6659e
- Added Apple OAuth sign-in to sign-in page
- Features:
  - "Continue with Apple" button with Apple logo (SVG)
  - Calls Supabase auth.signInWithOAuth({ provider: 'apple' })
  - Redirect URL configured to /auth/callback
  - Loading state with spinner when OAuth is in progress
  - Disabled state for all buttons during any auth operation
- Added Apple OAuth setup documentation to SETUP.md (detailed 5-step guide)
- **Files changed:**
  - app/auth/signin/page.tsx (modified - added Apple OAuth button + handler)
  - SETUP.md (modified - added Apple OAuth setup instructions)
- **Learnings for future iterations:**
  - Apple OAuth requires an Apple Developer Program membership ($99/year)
  - Apple Sign In requires creating both an App ID and a Services ID
  - The Services ID is what gets configured in Supabase, not the App ID
  - Apple OAuth button pattern is identical to Google - just change provider name
---

## 2026-01-11 - US-006
Thread: https://ampcode.com/threads/T-019babe3-2621-76b2-83ac-60fe9f65d864
- Created auth callback handler at /app/auth/callback/route.ts
- Features:
  - Exchanges auth code for session via supabase.auth.exchangeCodeForSession()
  - Checks if profile exists for the authenticated user
  - Creates profile record if new user (using user.id and full_name from metadata)
  - Redirects to homepage on success
  - Redirects to /auth/error with reason query param on failure
- **Files changed:**
  - app/auth/callback/route.ts (new)
- **Learnings for future iterations:**
  - Don't use generic Database type param with createServerClient when doing inserts - causes type conflicts
  - Use untyped createServerClient for route handlers that do simple inserts
  - Profile creation can fail silently - user still gets authenticated
---

## 2026-01-11 - US-007
Thread: https://ampcode.com/threads/T-019babe5-6f58-70ac-9d93-e423ce354b02
- Created auth error page at /app/auth/error/page.tsx
- Features:
  - Friendly error message based on `reason` query param (no_code, exchange_failed, invalid_token, access_denied)
  - "Try again" button linking to sign-in page
  - "Contact support" mailto link
  - Back to home link
  - Consistent styling with other auth pages
- Used Suspense boundary for useSearchParams (required by Next.js for static generation)
- **Files changed:**
  - app/auth/error/page.tsx (new)
- **Learnings for future iterations:**
  - useSearchParams requires Suspense boundary in Next.js 14 for pages to be statically pre-rendered
  - Extract the component using useSearchParams into a separate client component wrapped in Suspense
---

## 2026-01-11 - US-008
Thread: https://ampcode.com/threads/T-019babe8-2280-71eb-80e0-712377871cc9
- Created sign-out API endpoint at /app/api/auth/signout/route.ts
- Features:
  - POST endpoint using createServerClient pattern from auth/callback
  - Calls supabase.auth.signOut()
  - Redirects to homepage with 302 status
- **Files changed:**
  - app/api/auth/signout/route.ts (new)
- **Learnings for future iterations:**
  - Sign-out uses POST method for security (prevents CSRF via link clicks)
  - Reuse the same createServerClient cookie pattern from auth/callback
---
