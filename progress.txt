# Ralph Progress Log
Started: Sun 11 Jan 2026

## Codebase Patterns
- Database types are in lib/supabase/types.ts, re-exported from lib/supabase/client.ts
- SQL schema changes go in lib/supabase/schema.sql (single file, not migrations)
- **Browser client**: import from lib/supabase/browser.ts in client components (NOT client.ts which has server-side imports)
- Use explicit type annotations in React map callbacks to avoid implicit any errors
- Wrap useSearchParams() in Suspense boundary for Next.js static page generation
- API routes go in app/api/ directory, use createServerSupabaseClient from lib/supabase/client.ts
- Components go in app/components/ directory
- Use lucide-react for icons
- Clean .next cache with `rm -rf .next` if build fails with manifest errors
- Supabase TS types may infer `never` for insert/update; use `(supabase as any)` workaround with eslint-disable comment
- For optimistic UI: store previousState before API call, revert if response not ok

---

## 2026-01-11 - US-001
Thread: https://ampcode.com/threads/T-019ba9ab-ecb5-762e-b7e8-f60e0c1f4c72
- Created feedback database schema for community feedback system
- Files changed:
  - lib/supabase/schema.sql - Added 4 new tables: brief_votes, source_suggestions, error_reports, edit_proposals with RLS policies
  - lib/supabase/client.ts - Added TypeScript types for all new tables
  - app/brief/[id]/page.tsx - Fixed implicit any type errors in map callbacks (pre-existing issue)
- **Learnings for future iterations:**
  - Schema uses IF NOT EXISTS for table creation
  - RLS policies for user-created content follow pattern: insert requires auth.uid() = user_id, update uses USING (true) for system access
  - Use explicit type annotations in map callbacks: `(item: any, i: number) =>` or cast objects: `Object.entries(obj as Record<string, number>)`
---

## 2026-01-11 - US-002
Thread: https://ampcode.com/threads/T-019ba9b0-5af0-7029-8c53-4ffc37693cdc
- Created vote API endpoints for brief voting system
- Files changed:
  - app/api/briefs/[id]/vote/route.ts - New file with GET, POST, DELETE handlers
- **Learnings for future iterations:**
  - Next.js 14+ dynamic route params are `Promise<{ id: string }>` - must await them
  - Use `(supabase as any)` for insert/update when Supabase types infer `never`
  - API route handlers use `params: Promise<...>` pattern, not direct object access
---

## 2026-01-11 - US-003
Thread: https://ampcode.com/threads/T-019ba9b5-60e3-775d-ae93-f473f977848b
- Created VoteButtons component with upvote/downvote functionality
- Files changed:
  - app/components/VoteButtons.tsx - New file with interactive vote buttons
- **Learnings for future iterations:**
  - Components go in app/components/ directory (created it for this project)
  - Use createBrowserClient from lib/supabase/client.ts in client components
  - Optimistic UI: store previousState before API call, revert on error
  - Show different UI states: loading, authenticated, unauthenticated
---

## 2026-01-11 - US-004
Thread: https://ampcode.com/threads/T-019ba9b9-926a-75cb-bc76-8b4a11e5d02c
- Integrated VoteButtons component into brief page header
- Files changed:
  - app/brief/[id]/page.tsx - Added VoteButtons import and component next to clarity score
  - app/components/VoteButtons.tsx - Updated import to use browser.ts instead of client.ts
  - lib/supabase/browser.ts - New file for browser-only Supabase client
  - lib/supabase/types.ts - New file for shared database types
  - lib/supabase/client.ts - Refactored to use types.ts and re-export browser client
- **Learnings for future iterations:**
  - next/headers import makes a file server-only; split browser vs server Supabase clients into separate files
  - Browser client components must import from lib/supabase/browser.ts, not lib/supabase/client.ts
  - VoteButtons fetches vote state on mount via useEffect, shows loading skeleton during fetch
---

## 2026-01-11 - US-005
Thread: https://ampcode.com/threads/T-019ba9c3-135a-721d-bbda-f0f5b2d0883f
- Created suggest source API endpoint
- Files changed:
  - app/api/briefs/[id]/suggest-source/route.ts - New POST endpoint for source suggestions
- **Learnings for future iterations:**
  - URL validation: use `new URL(urlString)` in try/catch, returns false on exception
  - Pattern for returning created entity ID: `.select("id").single()` after insert
  - Status field defaults to 'pending' on creation
---

## 2026-01-11 - US-006
Thread: https://ampcode.com/threads/T-019ba9c5-0a2b-724a-bd3f-7a444f69b23f
- Created suggest source modal component
- Files changed:
  - app/components/SuggestSourceModal.tsx - New file with Radix Dialog-based modal
- **Learnings for future iterations:**
  - Use @radix-ui/react-dialog for modals (already in package.json)
  - Controlled modal pattern: accept `open` and `onOpenChange` props
  - Check auth on modal open, not on mount, to avoid unnecessary auth checks
  - Show success state inline in modal before auto-close for better UX
  - Modal will be integrated into brief page via FeedbackActions component (US-011/US-012)
---

## 2026-01-11 - US-007
Thread: https://ampcode.com/threads/T-019ba9c7-e1f8-749c-9c91-d66d1036dbea
- Created report error API endpoint
- Files changed:
  - app/api/briefs/[id]/report-error/route.ts - New POST endpoint for error reports
- **Learnings for future iterations:**
  - Same pattern as suggest-source: POST handler with auth check, validation, insert with status 'pending'
  - Error type validation uses const array and type inference: `const ERROR_TYPES = [...] as const; type ErrorType = (typeof ERROR_TYPES)[number]`
  - Description min length validation: simple `body.description.length < 20` check
---

## 2026-01-11 - US-008
Thread: https://ampcode.com/threads/T-019ba9c9-3ebf-7680-9ef6-579f2c53cfe7
- Created spot error modal component
- Files changed:
  - app/components/SpotErrorModal.tsx - New file with Radix Dialog-based modal for error reporting
- **Learnings for future iterations:**
  - Same controlled modal pattern as SuggestSourceModal: accept `open` and `onOpenChange` props
  - Character count display with color feedback (green when min reached)
  - Submit button uses orange color scheme to match error/warning theme
  - Modal will be integrated via FeedbackActions component (US-011/US-012)
---

## 2026-01-11 - US-009
Thread: https://ampcode.com/threads/T-019ba9ce-390c-74af-a04f-252471be4f54
- Created propose edit API endpoint
- Files changed:
  - app/api/briefs/[id]/propose-edit/route.ts - New POST endpoint for edit proposals
- **Learnings for future iterations:**
  - Same pattern as other feedback endpoints: POST handler with auth check, validation, insert with status 'pending'
  - Section validation uses const array: `const SECTIONS = ["summary", "narrative", "structured_data"] as const`
  - All three text fields (original_text, proposed_text, rationale) validated for min 20 chars
---

## 2026-01-11 - US-010
Thread: https://ampcode.com/threads/T-019ba9d0-0a6c-7688-9c95-f806ad4ae9be
- Created propose edit modal component
- Files changed:
  - app/components/ProposeEditModal.tsx - New file with Radix Dialog-based modal for edit proposals
- **Learnings for future iterations:**
  - Same controlled modal pattern as other feedback modals: accept `open` and `onOpenChange` props
  - Character count display with color feedback (green when min reached) for all three text fields
  - Submit button uses blue color scheme to match edit/improve theme
  - Modal will be integrated via FeedbackActions component (US-011/US-012)
---


## 2026-01-11 - US-011
Thread: https://ampcode.com/threads/T-019ba9db-96a6-750d-91ef-5ab7bb8ddcab
- Created FeedbackActions component with 3 feedback buttons
- Files changed:
  - app/components/FeedbackActions.tsx - New file with Suggest Source, Spot Error, Propose Edit buttons
- **Learnings for future iterations:**
  - FeedbackActions is a client component that manages modal open/close state internally
  - All three modals use same controlled pattern: `open` and `onOpenChange` props
  - Responsive design: `hidden sm:inline` for text to show icon-only on mobile
  - Will be integrated into brief page in US-012
---

## 2026-01-11 - US-012
Thread: https://ampcode.com/threads/T-019ba9de-5207-77e6-b596-c697694b192d
- Integrated FeedbackActions component into brief page
- Files changed:
  - app/brief/[id]/page.tsx - Replaced placeholder feedback section with FeedbackActions component, updated imports
- **Learnings for future iterations:**
  - FeedbackActions replaces the old placeholder feedback section in the brief page
  - Section uses same styling pattern as other brief page sections (bg-white, rounded-xl, border, p-6)
  - Removed unused imports (ThumbsUp, ThumbsDown, AlertCircle) after replacing placeholder buttons
---

## 2026-01-11 - US-013
Thread: https://ampcode.com/threads/T-019ba9e1-768f-73f1-9419-c969af0a63d4
- Created AI feedback screening service using Claude Haiku
- Files changed:
  - lib/services/feedback-screening.ts - New file with screenFeedback() function
- **Learnings for future iterations:**
  - Use same Anthropic pattern as research-agent.ts: new Anthropic({ apiKey }) + messages.create()
  - Use claude-3-5-haiku-20241022 for fast/cheap screening
  - Parse JSON with regex match(/\{[\s\S]*\}/) to handle Claude's sometimes-extra text
  - Default to pending (approved: false, flagged: false) on any AI error for graceful degradation
  - FeedbackType = "source_suggestion" | "error_report" | "edit_proposal"
---

## 2026-01-11 - US-014
Thread: https://ampcode.com/threads/T-019ba9e3-2aa7-7592-8fb8-5ee1cafd38a2
- Applied AI screening to source suggestions
- Files changed:
  - app/api/briefs/[id]/suggest-source/route.ts - Added async AI screening after insert, updates status based on result
- **Learnings for future iterations:**
  - AI screening is called asynchronously after insert using an IIFE: `(async () => { ... })()`
  - Status logic: flagged → 'flagged', approved && confidence > 0.9 → 'approved', else 'pending'
  - Same pattern will apply to error reports (US-015) and edit proposals (US-016)
---

## 2026-01-11 - US-015
Thread: https://ampcode.com/threads/T-019ba9e4-4dae-7013-abc7-35cac4f6a323
- Applied AI screening to error reports
- Files changed:
  - app/api/briefs/[id]/report-error/route.ts - Added async AI screening after insert, updates status based on result
- **Learnings for future iterations:**
  - Same pattern as source suggestions: async IIFE after insert, status logic (flagged → 'flagged', approved && confidence > 0.9 → 'approved', else 'pending')
  - Pass error_type and description to screenFeedback with type "error_report"
---

## 2026-01-11 - US-016
Thread: https://ampcode.com/threads/T-019ba9e5-b8d3-7481-8bbc-0a54d81637c6
- Applied AI screening to edit proposals
- Files changed:
  - app/api/briefs/[id]/propose-edit/route.ts - Added async AI screening after insert, updates status based on result
- **Learnings for future iterations:**
  - Same pattern as source suggestions and error reports: async IIFE after insert, status logic (flagged → 'flagged', approved && confidence > 0.9 → 'approved', else 'pending')
  - Pass original_text, proposed_text, rationale to screenFeedback with type "edit_proposal"
---

## 2026-01-11 - US-017
Thread: https://ampcode.com/threads/T-019ba9e7-0837-7559-8544-f1f0da8c6c4c
- Created admin feedback review page with protected route
- Files changed:
  - app/admin/feedback/page.tsx - New admin page with tabs, feedback list, expandable rows
  - app/api/admin/feedback/route.ts - New GET endpoint to fetch all feedback items
- **Learnings for future iterations:**
  - Admin routes use email check: ADMIN_EMAILS includes or ends with @stateofclarity.com
  - Fetching from multiple tables (source_suggestions, error_reports, edit_proposals) and combining into unified FeedbackItem type
  - Use `(supabase as any)` workaround with eslint-disable comment for Supabase never type inference issues
  - Browser verification may need dev server restart if new pages aren't picked up (rm -rf .next)
---
