# Ralph Progress Log
Started: Sat 10 Jan 2026 02:10:52 +04

## Codebase Patterns
- Use Claude Haiku (claude-3-5-haiku-20241022) for fast/cheap LLM operations like classification
- Use Claude Sonnet for higher quality operations (reconciliation, complex analysis)
- Types belong in /lib/types/ directory
- Pre-existing type errors may exist in app/brief/[id]/page.tsx - use explicit type casts for JSONB fields
- FixerType enum uses camelCase (e.g., FixerType.firstPrinciplesCoherence, not FirstPrinciplesCoherence)
- Fixer subclass pattern: extend BaseFixer, set fixerType & description, implement buildPrompt(input)

---

## 2026-01-10 11:15 - US-001
Thread: https://ampcode.com/threads/T-019ba4d0-04d6-7331-bbb7-29dc7127c80f
- Created /lib/types/refinement.ts with all fixer agent types
- Defined FixerType enum with 7 dimensions (firstPrinciplesCoherence, internalConsistency, evidenceQuality, accessibility, objectivity, factualAccuracy, biasDetection)
- Defined SuggestedEdit, FixerResult, RefinementAttempt, RefinementResult, FixerInput, DimensionScores, ConsensusResult, ReconciliationResult interfaces
- Fixed pre-existing type errors in app/brief/[id]/page.tsx (implicit any types in map callbacks)
- Files changed: lib/types/refinement.ts (new), app/brief/[id]/page.tsx (fixes)
- **Learnings for future iterations:**
  - JSONB fields from Supabase need explicit type casts (e.g., `as Record<string, number>`)
  - brief.sources, brief.clarity_critique.breakdown, etc. need explicit types in .map()
  - Always run `npm run build` to catch type errors before committing
---

## 2026-01-10 11:30 - US-002
Thread: https://ampcode.com/threads/T-019ba4d4-6eb5-7392-a2b5-073f86b99111
- Created /lib/agents/fixers/base-fixer.ts with abstract BaseFixer class
- Implemented suggestEdits method returning Promise<FixerResult>
- Added retry wrapper with exponential backoff (3 retries, 1s/2s/4s delays)
- Common logic: prompt building, LLM call with Claude Haiku, JSON response parsing
- System prompt template for fixer agents with standardized response format
- Subclasses must implement: buildPrompt(input) and fixerType/description properties
- Files changed: lib/agents/fixers/base-fixer.ts (new)
- **Learnings for future iterations:**
  - No existing retry-wrapper.ts exists; created inline withRetry function in base-fixer
  - Use @anthropic-ai/sdk for LLM calls (already installed in project)
  - Fixer agents directory structure: /lib/agents/fixers/
  - Response parsing extracts JSON from LLM response using regex (Claude sometimes adds text)
---

## 2026-01-10 12:00 - US-003
Thread: https://ampcode.com/threads/T-019ba4d6-7d6e-72bf-803d-0e442331c197
- Created /lib/agents/fixers/first-principles-fixer.ts extending BaseFixer
- Prompt focuses on: gaps in logical chain, unstated assumptions, incomplete reasoning, foundation clarity
- Files changed: lib/agents/fixers/first-principles-fixer.ts (new)
- **Learnings for future iterations:**
  - FixerType enum uses camelCase (e.g., firstPrinciplesCoherence, not FirstPrinciplesCoherence)
  - Pattern for fixer subclasses: implement fixerType, description, and buildPrompt(input)
---

## 2026-01-10 - US-004
Thread: https://ampcode.com/threads/T-019ba4d8-c1d5-7044-8c1f-2db5981d2a91
- Created /lib/agents/fixers/consistency-fixer.ts extending BaseFixer
- Prompt focuses on: contradictions between sections, source support resolution, terminology consistency, narrative coherence
- Files changed: lib/agents/fixers/consistency-fixer.ts (new)
- **Learnings for future iterations:**
  - All fixer agents follow same pattern: extend BaseFixer, set fixerType & description, implement buildPrompt(input)
  - Import FixerType and FixerInput from @/lib/types/refinement
---

## 2026-01-10 - US-005
Thread: https://ampcode.com/threads/T-019ba4da-226f-739d-9186-0c8a0a5df0f9
- Created /lib/agents/fixers/evidence-fixer.ts extending BaseFixer
- Prompt focuses on: claims lacking citation, weak/inadequate citations, over-reliance on single source, source-claim alignment
- Files changed: lib/agents/fixers/evidence-fixer.ts (new)
- **Learnings for future iterations:**
  - Evidence fixer follows identical pattern to other fixers
  - Each fixer focuses on 4 key areas within its dimension
---

## 2026-01-10 - US-006
Thread: https://ampcode.com/threads/T-019ba4db-8e59-7329-ae05-fdb4838c0d0d
- Created /lib/agents/fixers/accessibility-fixer.ts extending BaseFixer
- Prompt focuses on: jargon/technical terms, overly complex sentences, reading level alignment, structural clarity
- Files changed: lib/agents/fixers/accessibility-fixer.ts (new)
- **Learnings for future iterations:**
  - Accessibility fixer follows identical pattern to other fixers
  - Focus areas: jargon replacement, sentence simplification, reading level, structure
---

## 2026-01-10 - US-007
Thread: https://ampcode.com/threads/T-019ba4dc-de11-7361-bfce-7a90f7222737
- Created /lib/agents/fixers/objectivity-fixer.ts extending BaseFixer
- Prompt focuses on: underrepresented perspectives, missing counterarguments, one-sided framing, balance and proportion
- Files changed: lib/agents/fixers/objectivity-fixer.ts (new)
- **Learnings for future iterations:**
  - Objectivity fixer follows identical pattern to other fixers
  - Focus areas: perspectives, counterarguments, framing neutrality, balance
---

## 2026-01-10 - US-008
Thread: https://ampcode.com/threads/T-019ba4de-33ae-7767-9771-1397f94f0966
- Created /lib/agents/fixers/factual-accuracy-fixer.ts extending BaseFixer
- Prompt focuses on: specific factual claims identification, cross-referencing against sources, flagging unsupported claims, suggesting corrections/hedging
- Files changed: lib/agents/fixers/factual-accuracy-fixer.ts (new)
- **Learnings for future iterations:**
  - Factual accuracy fixer follows identical pattern to other fixers
  - Focus areas: claim identification, source verification, hedging language, corrections
---

## 2026-01-10 - US-009
Thread: https://ampcode.com/threads/T-019ba4df-a07d-73dd-b9bf-a65b2c623670
- Created /lib/agents/fixers/bias-fixer.ts extending BaseFixer
- Prompt focuses on: loaded language, selective emphasis, framing bias, attribution/sourcing bias
- Files changed: lib/agents/fixers/bias-fixer.ts (new)
- **Learnings for future iterations:**
  - Bias fixer follows identical pattern to other fixers
  - Focus areas: loaded language, selective emphasis, framing, attribution bias
  - All 7 fixer agents now complete (US-003 through US-009)
---

## 2026-01-10 - US-010
Thread: https://ampcode.com/threads/T-019ba4e1-312f-71fe-ad6a-788583aa3af5
- Created /lib/agents/fixers/fixer-orchestrator.ts
- Receives ConsensusResult with dimension breakdown
- Determines which fixers to deploy based on dimension scores <7.0 threshold
- Creates fixer instances dynamically based on FixerType
- Runs all needed fixers in parallel using Promise.all
- Collects all SuggestedEdit arrays from fixer results
- Logs deployment decisions, dimension scores, and results with timing
- Files changed: lib/agents/fixers/fixer-orchestrator.ts (new)
- **Learnings for future iterations:**
  - Orchestrator returns OrchestratorResult with fixersDeployed, fixerResults, allSuggestedEdits
  - Use createFixerInstance(fixerType) to dynamically instantiate fixer classes
  - SCORE_THRESHOLD = 7.0 for triggering fixer deployment
---

## 2026-01-10 - US-011
Thread: https://ampcode.com/threads/T-019ba4e6-e892-77cd-9588-c26e505d4320
- Created /lib/agents/fixers/edit-reconciliation-agent.ts
- Receives original brief + FixerResult[] from orchestrator
- Groups edits by section to detect conflicts
- Prioritizes edits by: priority weight (critical>high>medium>low), fixer agreement count
- Detects conflicts via text overlap detection (editsConflict function)
- Selects non-conflicting edits, skips lower-priority conflicts with reasons
- Uses Claude Sonnet (claude-sonnet-4-20250514) for high-quality edit application
- Returns ReconciliationResult: revisedBrief, editsApplied, editsSkipped with reasons
- Files changed: lib/agents/fixers/edit-reconciliation-agent.ts (new)
- **Learnings for future iterations:**
  - Use ReconciliationInput interface: { originalBrief: string, fixerResults: FixerResult[] }
  - reconcileEdits() is the main function to call
  - Conflict detection uses text overlap (one originalText contains another)
  - Priority weights: critical=4, high=3, medium=2, low=1
---

## 2026-01-10 - US-012
Thread: https://ampcode.com/threads/T-019ba4ea-db8f-742f-b7ba-36a8fbb68f75
- Created /lib/agents/refinement-loop.ts
- Implemented refineUntilPassing(input: RefinementLoopInput): Promise<RefinementResult>
- Accepts: brief, initialConsensusResult, sources, scoringFunction, maxAttempts (default 3)
- Each iteration: orchestrateFixes -> reconcileEdits -> scoringFunction (re-score)
- Stops early if score >= 8.0 (TARGET_SCORE)
- Tracks all attempts with before/after scores for dimensions
- Returns final brief, final score, attempts array, success boolean, and warning reason if failed
- Files changed: lib/agents/refinement-loop.ts (new)
- **Learnings for future iterations:**
  - Refinement loop accepts scoringFunction as dependency injection for testability
  - RefinementLoopInput interface requires: brief, initialConsensusResult, scoringFunction
  - TARGET_SCORE = 8.0, MAX_ATTEMPTS = 3
  - trackDimensionScoreChanges() compares before/after ConsensusResult for dimension-level tracking
---
