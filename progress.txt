# Ralph Progress Log
Started: Wed 14 Jan 2026 21:28:27 +04

## Codebase Patterns
- Services go in `/lib/services/` with JSDoc comments on all exported functions
- Use types from `/lib/types/accountability.ts` for accountability features
- Handle 404 responses gracefully by returning empty arrays (not throwing)
- Implement retry logic with exponential backoff (1s/2s/4s delays, 3 attempts)
- Use `verificationStatus: "verified"` for official API sources, `"unverified"` for web scraped data

---

## 2026-01-14 21:30 - US-001
Thread: https://ampcode.com/threads/T-019bbd8d-3be0-707c-bf81-b961cf91c967
- Created Companies House API service file at `/lib/services/companies-house-api.ts`
- Added COMPANIES_HOUSE_API_KEY to .env.example
- Implemented:
  - `getCompaniesHouseAuthHeader()` - Basic Auth header generation
  - `searchOfficers(name)` - Search officers endpoint
  - `getOfficerAppointments(officerId)` - Get appointments for an officer
  - `fetchCompaniesHouseProfile(entityName)` - Full profile with retry logic
- All functions have JSDoc comments
- 404 responses return empty arrays (graceful handling)
- **Learnings for future iterations:**
  - Pre-existing test errors in `__tests__/` directory - not blocking commits
  - Types `CompanyRecord` and `InvestigationSource` already defined in accountability.ts
  - Companies House API uses Basic Auth with API key as username and empty password
---

## 2026-01-14 21:32 - US-002
Thread: https://ampcode.com/threads/T-019bbd8f-6ea9-749c-9e2e-c8902203291f
- US-002 was already implemented as part of US-001 commit
- `fetchCompaniesHouseProfile(entityName)` function verified at lines 144-237 in companies-house-api.ts
- Returns `{ records: CompanyRecord[]; sources: InvestigationSource[] }`
- Has retry logic with exponential backoff (3 attempts, 1s/2s/4s delays)
- Creates sources with `sourceType: "companies_house"` and `verificationStatus: "verified"`
- Typecheck passes
---

## 2026-01-14 21:35 - US-003
Thread: https://ampcode.com/threads/T-019bbd8f-6ea9-749c-9e2e-c8902203291f
- Created `/lib/parsers/charity-commission-parser.ts`
- Implemented `fetchCharityCommissionData(entityName)` function
- Uses Tavily search with query: `"[name]" trustee site:register-of-charities.charitycommission.gov.uk`
- Parses charity numbers from URLs using regId and /charity/ patterns
- Returns `{ records: CharityRecord[]; sources: InvestigationSource[] }`
- Sources have `verificationStatus: "unverified"` (web scraped data)
- Typecheck passes
- **Learnings for future iterations:**
  - Created `/lib/parsers/` directory for Tavily-based parsers
  - Tavily pattern: use `safeAICall` wrapper for error handling
  - Use `include_domains` param to limit search to specific sites
---

## 2026-01-14 21:34 - US-004
Thread: https://ampcode.com/threads/T-019bbd91-fe11-75ad-8463-f3eb956e2bf3
- Created `/lib/parsers/parliament-parser.ts`
- Implemented `fetchRegisterOfInterests(entityName)` function
- Uses Tavily search with query: `"[name]" "register of interests" site:parliament.uk`
- Parses interest categories: Employment, Donations, Land, Shareholdings
- Extracts monetary values with £ symbol patterns
- Returns `{ records: InterestDeclaration[]; sources: InvestigationSource[] }`
- Sources have `verificationStatus: "unverified"` (web scraped data)
- Returns empty arrays if no results (graceful handling for non-MPs)
- Typecheck passes
- **Learnings for future iterations:**
  - Use typed category literals (e.g., `type InterestCategory = "Employment" | ...`) for type safety
  - Extract dates from content with regex, fallback to current date
  - Deduplicate results using `Set<string>` on URLs
---

## 2026-01-14 21:40 - US-005
Thread: https://ampcode.com/threads/T-019bbd93-a976-76bb-8a2f-a86d8cee5ec3
- Created `/lib/parsers/electoral-commission-parser.ts`
- Implemented `fetchElectoralCommissionData(entityName)` function
- Uses Tavily search with query: `"[name]" donations site:search.electoralcommission.org.uk`
- Extracts £ amounts using regex `/£([\d,]+(?:\.\d{2})?)/g`
- Returns `{ records: Donation[]; sources: InvestigationSource[] }`
- Parses donation types (Cash, Services, Sponsorship, Loan)
- Extracts donor/recipient context from content
- Sources have `verificationStatus: "unverified"` (web scraped data)
- Typecheck passes
- **Learnings for future iterations:**
  - Extract multiple amounts per result (loop through regex matches)
  - Donation type can be inferred from keywords: cash, services, sponsorship, loan
  - Donor/recipient direction can be inferred from context words like "donated to" or "received from"
---

## 2026-01-14 21:45 - US-006
Thread: https://ampcode.com/threads/T-019bbd95-59bf-77b5-93fe-1980ac2e6d53
- Created `/lib/parsers/contracts-finder-parser.ts`
- Implemented `fetchGovernmentContracts(entityName)` function
- Uses Tavily search with query: `"[name]" site:contractsfinder.service.gov.uk`
- Extracts contract values supporting £m, £bn, and standard amounts
- Returns `{ records: Contract[]; sources: InvestigationSource[] }`
- Maps to Contract type with: contractTitle, buyer, supplier, value, awardDate, sourceUrl
- Sources have `verificationStatus: "unverified"` (web scraped data)
- Typecheck passes (no errors specific to this file)
- **Learnings for future iterations:**
  - Contract type requires: contractTitle, buyer, supplier, value, awardDate, sourceUrl
  - Value extraction should handle £m/million and £bn/billion suffixes
  - Government department names can be matched from a curated list or extracted from "awarded by" patterns
---

## 2026-01-14 21:50 - US-007
Thread: https://ampcode.com/threads/T-019bbd97-50e4-773b-9b8b-63301a942449
- Created `/lib/services/uk-public-data-service.ts`
- Implemented `fetchUKPublicData(targetEntity, entityType)` orchestrator
- Defined types: `UKPublicDataResult`, `DataSourceError`, `PartialUKProfileData`
- Calls all 5 data sources in parallel using `Promise.all` with safe wrappers
- Each source wrapped in try-catch via `safeDataSourceCall` for graceful degradation
- Aggregates results from all sources into single `profileData` object
- Collects all sources and errors arrays
- Implements `isRecoverableError` to classify transient vs permanent errors
- Skips Contracts Finder for individuals (logs skip reason)
- Typecheck passes
- **Learnings for future iterations:**
  - Use wrapper function pattern for graceful degradation instead of dynamic fetcher arrays (avoids TypeScript union type issues)
  - `Promise.all` with explicit typed promises is cleaner than `Promise.allSettled` with generic handlers
  - Pre-existing test errors in `__tests__/` don't block commits
---

## 2026-01-14 22:10 - US-008
Thread: https://ampcode.com/threads/T-019bbd99-7de8-763f-a0e0-6724533522db
- Added caching to UK public data service orchestrator
- Used existing `withCache` utility from `/lib/cache/with-cache.ts`
- Cache key format: `uk_data:{source}:{normalized_entity_name}`
- Implemented TTLs per spec:
  - Companies House: 24hrs (86400s)
  - Charity Commission: 24hrs (86400s)
  - Register of Interests: 12hrs (43200s)
  - Electoral Commission: 12hrs (43200s)
  - Contracts Finder: 24hrs (86400s)
- Cache hit/miss logging done by withCache utility automatically
- Typecheck passes (pre-existing test errors not related to this change)
- **Learnings for future iterations:**
  - `withCache` already logs hits/misses via console.log `[Cache] HIT/MISS: {key}`
  - Normalize cache keys by lowercasing, trimming, and replacing spaces with underscores
  - Cache wrapper goes inside `safeDataSourceCall` fetcher function
---

## 2026-01-14 23:05 - US-009
Thread: https://ampcode.com/threads/T-019bbd9b-68d8-701c-bea0-e9a3332e6e40
- Added Sentry error logging to UK public data service
- Imported `@sentry/nextjs` in uk-public-data-service.ts
- Updated `safeDataSourceCall` to log errors with:
  - Tags: component 'uk-public-data', source name, normalized entity name
  - Extra: entityType, errorType (transient/permanent), entityName, recoverable
- Added `getErrorType()` helper function to classify transient vs permanent errors
- Transient errors (timeout, 500, 502, 503, network issues) marked `recoverable: true`
- Permanent errors (404, 401, 403) marked `recoverable: false`
- Typecheck passes (pre-existing test errors not related to this change)
- **Learnings for future iterations:**
  - Use `@sentry/nextjs` for Sentry imports (consistent with other files)
  - Tags are indexed for filtering, Extra is for additional context
  - Pass entity context through wrapper functions for proper error tagging
---
