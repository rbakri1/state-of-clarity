# Ralph Progress Log
Started: Wed 14 Jan 2026 22:26:06 +04

## Codebase Patterns
- Agent persona files export string constants for system prompts (see specialist-personas.ts and accountability-personas.ts for patterns)
- Types for accountability features are in lib/types/accountability.ts
- Use @langchain/langgraph for state machine orchestration (already in dependencies)
- Pass callbacks through LangGraph state annotation rather than closures (callbacks field in state)
- Use optional chaining (?.) for callback invocations to make them optional
- Use parseJsonWithRetry() from json-parse-retry.ts for LLM JSON extraction with automatic retry on parse failure
---

## 2026-01-14 - US-001
Thread: https://ampcode.com/threads/T-019bbdc2-051a-725c-b4ad-e2b2b36254ba
- Created centralized system prompts for all 5 accountability tracker agents
- File created: lib/agents/accountability-personas.ts
- Prompts: ENTITY_CLASSIFICATION_PROMPT (99 words), UK_PROFILE_RESEARCH_PROMPT (411 words), CORRUPTION_ANALYSIS_PROMPT (362 words), ACTION_LIST_GENERATION_PROMPT (329 words)
- All prompts use conditional language and include ethical framing
- Corruption prompt mandates innocentExplanations for every scenario
- **Learnings for future iterations:**
  - Existing test files have pre-existing type errors (unrelated to this work)
  - Follow the pattern in specialist-personas.ts for persona exports
---

## 2026-01-14 - US-002
Thread: https://ampcode.com/threads/T-019bbdc4-9153-750e-b5d4-d9453d3a6e07
- Created LangGraph state annotation and types for accountability tracker pipeline
- File created: lib/agents/accountability-tracker-orchestrator.ts
- Defined AccountabilityState interface with all required fields
- Created AccountabilityStateAnnotation using Annotation.Root from @langchain/langgraph
- Added concatenation reducer for completedSteps array
- Added replace reducers for object fields (profileData, corruptionScenarios, actionItems, etc.)
- **Learnings for future iterations:**
  - Follow the existing pattern in langgraph-orchestrator.ts for state annotations
  - Use `reducer: (prev, next) => next ?? prev` for fields that should be replaced
  - Use `reducer: (prev, next) => [...prev, ...next]` for arrays that accumulate
---

## 2026-01-14 - US-003
Thread: https://ampcode.com/threads/T-019bbdc6-5ba8-7788-a930-7dbb9f38d2fe
- Implemented entity classification agent for individual/organization classification
- File created: lib/agents/entity-classification-agent.ts
- Uses Claude Haiku (claude-haiku-4-5-20251001) for cost efficiency
- Checks for organization suffixes (Ltd, Limited, PLC, etc.) before calling LLM
- Parses JSON response with entityType, confidence, reasoning
- Defaults to 'individual' if response is ambiguous or unparseable
- Returns updated state with entityType and adds 'entity_classification' to completedSteps
- **Learnings for future iterations:**
  - Use claude-haiku-4-5-20251001 (not claude-3-haiku-20240307) per codebase convention
  - Follow question-classifier.ts pattern for Anthropic API calls and JSON parsing
  - Pre-existing test file type errors don't block implementation work
---

## 2026-01-14 - US-004
Thread: https://ampcode.com/threads/T-019bbdc8-3716-723c-9c15-3476d124107e
- Implemented UK profile research agent for fetching and synthesizing UK public data
- File created: lib/agents/uk-profile-research-agent.ts
- Calls fetchUKPublicData() to fetch from 5 UK public data sources in parallel
- Uses Claude Sonnet (claude-sonnet-4-20250514) for profile synthesis (not Opus as it's not available)
- Adds each source to investigation via addInvestigationSource()
- Creates sparse profile when no data is available (graceful degradation)
- Returns profileData and adds 'uk_profile_research' to completedSteps
- **Learnings for future iterations:**
  - Use claude-sonnet-4-20250514 instead of claude-3-opus-20240229 (per codebase convention)
  - Follow entity-classification-agent.ts pattern for JSON extraction and error handling
  - Pre-existing test file type errors don't block implementation work
---

## 2026-01-14 - US-005
Thread: https://ampcode.com/threads/T-019bbdca-3856-7474-8d36-0cf7bb66163e
- Implemented corruption analysis agent for generating theoretical corruption scenarios
- File created: lib/agents/corruption-analysis-agent.ts
- Uses Claude Sonnet (claude-sonnet-4-20250514) for complex scenario reasoning
- Generates 3 generic scenarios for sparse profile data (separate for individuals vs organizations)
- Validates innocentExplanations array is non-empty for each scenario
- Logs warnings if accusatory language detected (e.g., "is corrupt")
- Ensures all scenarios have innocentExplanations (adds defaults if missing from LLM response)
- Returns corruptionScenarios and adds 'corruption_analysis' to completedSteps
- **Learnings for future iterations:**
  - HistoricalCase.sourceUrl is optional string (undefined), not null
  - Follow uk-profile-research-agent.ts pattern for JSON array extraction (use regex /\[[\s\S]*\]/)
  - Generic scenarios provide graceful fallback when profile data is sparse
---

## 2026-01-14 - US-006
Thread: https://ampcode.com/threads/T-019bbdd0-430b-754c-8f2a-9976c84d8857
- Implemented action list generation agent for prioritized investigation actions
- File created: lib/agents/action-list-agent.ts
- Uses Claude Sonnet (claude-sonnet-4-20250514) for reasoning about investigative approaches
- Generates 10 default action items when profile/scenarios are sparse
- Validates banned words (hack, bribe, stalk, harass, threaten) and removes violating actions
- Validates priority balance (warns if >60% are priority 1)
- Ensures all action items have relatedScenarios field
- Supplements with default items if fewer than 8 valid items returned
- Returns actionItems and adds 'action_list_generation' to completedSteps
- **Learnings for future iterations:**
  - Follow corruption-analysis-agent.ts pattern for JSON array extraction
  - Use generateDefaultActionItems() for graceful fallback when LLM data is sparse
  - Filter out invalid action items rather than failing completely
---

## 2026-01-14 - US-007
Thread: https://ampcode.com/threads/T-019bbdd5-9919-75d5-8a84-a4ad3a6d56a0
- Implemented quality check agent as final pipeline step
- File created: lib/agents/quality-check-agent.ts
- Calls getInvestigationSources() to count data sources used
- Calls calculateQualityScore() with profile data, scenarios, and source count
- Persists all results via updateInvestigationResults()
- Logs quality gate pass/fail status with score to console
- Returns qualityScore, qualityNotes, and adds 'quality_check' to completedSteps
- **Learnings for future iterations:**
  - Quality score calculation uses data_sources_count from investigation sources table
  - Quality gate threshold is 6.0 (scores >= 6.0 pass)
  - Pre-existing test file type errors don't block implementation work
---

## 2026-01-14 - US-008
Thread: https://ampcode.com/threads/T-019bbdd7-7e18-73eb-9ba6-3998ef75a430
- Created LangGraph to wire up all 5 agents sequentially
- File modified: lib/agents/accountability-tracker-orchestrator.ts
- Imported all 5 agent node functions
- Created StateGraph with AccountabilityStateAnnotation
- Added nodes: entity_classification, uk_profile_research, corruption_analysis, action_list_generation, quality_check
- Added sequential edges from START through all agents to END
- Exported createAccountabilityGraph() function and compiled accountabilityGraph
- **Learnings for future iterations:**
  - Follow langgraph-orchestrator.ts pattern for StateGraph creation
  - Import StateGraph, END, START from @langchain/langgraph
  - Use .addNode() for each agent function, .addEdge() to connect them sequentially
---

## 2026-01-14 - US-009
Thread: https://ampcode.com/threads/T-019bbdda-52a0-7024-9af7-e0aa2495907a
- Implemented main execution function with callbacks for SSE streaming
- File modified: lib/agents/accountability-tracker-orchestrator.ts
- Defined AccountabilityCallbacks interface with onAgentStarted, onAgentCompleted, onStageChanged, onError
- Defined AccountabilityReportResult type for consistent return values
- Created generateAccountabilityReport() function that invokes the compiled graph
- Wrapped execution in try-catch with onError callback support
- Logs start/end times and calculates total duration
- **Learnings for future iterations:**
  - Callbacks are passed to the function but not yet threaded through to individual agents (US-010 will handle this)
  - The graph.invoke() returns the final state directly
  - Pre-existing test file type errors don't block implementation work
---

## 2026-01-14 - US-010
Thread: https://ampcode.com/threads/T-019bbddc-a284-769d-9d19-8cb328a844f3
- Added callback emissions to all 5 accountability tracker agents for SSE streaming
- Modified orchestrator to pass callbacks through state annotation (added callbacks field to AccountabilityState)
- Each agent now emits onAgentStarted at beginning, onAgentCompleted at end with duration
- Entity classification emits onStageChanged('classifying')
- UK profile research emits onStageChanged('researching')
- Corruption analysis emits onStageChanged('analyzing')
- Action list emits onStageChanged('generating')
- Quality check emits onStageChanged('checking')
- Callbacks are optional - agents work without them (using optional chaining)
- Files modified: accountability-tracker-orchestrator.ts, entity-classification-agent.ts, uk-profile-research-agent.ts, corruption-analysis-agent.ts, action-list-agent.ts, quality-check-agent.ts
- **Learnings for future iterations:**
  - Use optional chaining (?.) for callback invocations to make them truly optional
  - Pass callbacks through state annotation rather than closures for LangGraph compatibility
  - Track startTime at beginning of agent function to calculate accurate durationMs
---

## 2026-01-14 - US-011
Thread: https://ampcode.com/threads/T-019bbdec-9f65-717a-90af-e3fa3f63cc1c
- Created JSON parsing retry helper for LLM responses
- File created: lib/agents/json-parse-retry.ts
- Exports parseJsonWithRetry() - retries LLM call with stricter prompt on JSON parse failure
- Exports createStricterPrompt() - appends "CRITICAL: You MUST return valid JSON only" on retry
- Updated uk-profile-research-agent.ts to use parseJsonWithRetry for profile synthesis
- Updated corruption-analysis-agent.ts to use parseJsonWithRetry for scenario generation
- Updated action-list-agent.ts to use parseJsonWithRetry for action item generation
- All agents fall back gracefully to defaults after retries exhausted
- Build passes (pre-existing test type errors don't block)
- **Learnings for future iterations:**
  - Use llmCall callback pattern with isRetry boolean to control prompt modification
  - Use extractJson function parameter to handle object ({}) vs array ([]) extraction
  - Each agent can use different max_tokens based on expected response size
---
