# Ralph Progress Log
Started: Sun 11 Jan 2026 22:25:49 +04

## Codebase Patterns
- Use `npm run build` to typecheck the project
- Vercel KV uses `kv` export from `/lib/cache/kv-client.ts` with automatic fallback to in-memory
- Cache key format convention: `{resource}:{id}` e.g., `brief:abc123`
- Use `(supabase.from("table") as any).update()` for Supabase updates due to type inference issues

---

## Sun 11 Jan 2026 - US-001
Thread: https://ampcode.com/threads/T-019bae4e-ae00-73d7-bded-6c3376816c72
- Installed @vercel/kv, tailwindcss-animate, @supabase/ssr packages
- Created /lib/cache/kv-client.ts with KVClient interface, VercelKVClient, and InMemoryKV fallback
- Added KV_REST_API_URL and KV_REST_API_TOKEN to .env.example
- Documented Vercel KV setup in SETUP.md (Step 5)
- Fixed pre-existing type errors in app/brief/[id]/page.tsx (implicit any types)
- **Learnings for future iterations:**
  - The npm install may remove existing packages; always run `npm install` after adding new packages
  - Main branch has some pre-existing type errors that need fixing
  - Use explicit type annotations in .map() callbacks when dealing with `any` typed objects
---

## Sun 11 Jan 2026 - US-002
Thread: https://ampcode.com/threads/T-019bae54-24f7-76e8-b9cc-fcd76b72026c
- Created /lib/cache/with-cache.ts with generic withCache<T> function
- Function checks cache first, executes fn on miss, stores result with TTL
- Logs cache hits/misses with [Cache] HIT/MISS prefix
- Handles cache read/write errors gracefully (logs and proceeds with direct fetch)
- **Learnings for future iterations:**
  - Use `withCache(key, fn, ttlSeconds)` pattern to wrap any async operation
  - Cache errors are logged but never block the main operation
---

## Sun 11 Jan 2026 - US-003
Thread: https://ampcode.com/threads/T-019bae55-50ee-7206-b48b-b8bb74a66687
- Created /lib/cache/invalidate.ts with invalidateCache and invalidatePattern functions
- invalidateCache(key) deletes a single key and logs the event
- invalidatePattern(pattern) finds keys matching pattern and deletes them all
- All errors are caught and logged, never thrown (consistent with with-cache.ts)
- **Learnings for future iterations:**
  - Use `invalidateCache('brief:${id}')` to clear a specific brief cache
  - Use `invalidatePattern('brief:*')` to clear all brief caches
---

## Sun 11 Jan 2026 - US-004
Thread: https://ampcode.com/threads/T-019bae5c-8c0b-76ad-9396-b3fe5e68026d
- Created /lib/services/brief-service.ts with getBriefById function
- Uses withCache wrapper with key format `brief:{id}` and 300 second TTL
- Fetches from Supabase using createServiceRoleClient
- Returns null for not found (PGRST116 error), throws for other errors
- **Learnings for future iterations:**
  - lib/services directory did not exist; created it for this story
  - Use `createServiceRoleClient()` for server-side data fetching that bypasses RLS
  - PGRST116 is the Supabase error code for "no rows found"
---

## Sun 11 Jan 2026 - US-005
Thread: https://ampcode.com/threads/T-019bae5e-e328-7158-a40c-4a786c7e1158
- Added updateBriefFromState and updateBriefClassification functions to /lib/services/brief-service.ts
- Both functions call invalidateCache for the specific brief and "briefs:popular" key after successful update
- Used `as any` cast on supabase.from("briefs") to work around Database type inference issue
- **Learnings for future iterations:**
  - Supabase's typed client may infer `never` for .update() if Database types are incomplete
  - Use `(supabase.from("table") as any).update()` pattern to work around strict types
  - Always invalidate both specific cache key and related collection caches (e.g., `briefs:popular`)
---

## Sun 11 Jan 2026 - US-006
Thread: https://ampcode.com/threads/T-019bae66-6ec8-723d-9df1-39662742c0a5
- Verified /app/api/briefs/[id]/route.ts GET endpoint was already implemented
- Fetches brief using getBriefById from brief-service (uses withCache)
- Returns 404 JSON response if brief not found
- Sets Cache-Control: public, s-maxage=60, stale-while-revalidate=300
- Sets ETag header based on brief.updated_at timestamp
- Returns 304 Not Modified when If-None-Match matches ETag
- Typecheck passes
- **Learnings for future iterations:**
  - Next.js 14+ uses `params: Promise<{ id: string }>` for dynamic route params (must await)
  - ETag comparison uses exact string match of `"${updated_at}"`
---
