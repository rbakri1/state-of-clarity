# Ralph Progress Log
Started: Wed 14 Jan 2026 20:29:18 +04

## Codebase Patterns
- Use `npm run type-check` (not `typecheck`) for TypeScript checking
- Migrations go in `/lib/supabase/migrations/` with sequential numbering (001, 002, etc.)
- Use `IF NOT EXISTS` for CREATE TABLE to ensure idempotency
- Use `DROP TRIGGER IF EXISTS` before CREATE TRIGGER for idempotency
- Use `CREATE INDEX IF NOT EXISTS` for idempotent index creation
- Use `DROP POLICY IF EXISTS` before CREATE POLICY for idempotent RLS policies
- RLS on child tables: use `EXISTS (SELECT 1 FROM parent WHERE parent.user_id = auth.uid())`
- Service role access: `auth.jwt() ->> 'role' = 'service_role'`
- Pre-existing typecheck errors in test files - not blocking for SQL migrations
---

## 2026-01-14 16:30 - US-001
Thread: https://ampcode.com/threads/T-019bbd57-1602-765b-bd13-f12132dba7f4
- Created accountability_investigations table in migration 013
- Includes all columns: id, user_id, target_entity, entity_type, ethics_acknowledged_at, profile_data, corruption_scenarios, action_items, quality_score, quality_notes, generation_time_ms, data_sources_count, is_public, created_at, updated_at
- Added CHECK constraint for entity_type (individual/organization)
- Added CHECK constraint for quality_score (0-10)
- Created updated_at trigger function
- Files changed: lib/supabase/migrations/013_add_accountability_tracker_tables.sql
- **Learnings for future iterations:**
  - Pre-existing typecheck errors in test files - not blocking for SQL migrations
  - Pattern: Use `gen_random_uuid()` for UUID primary keys
  - Pattern: Use `TIMESTAMPTZ` for all timestamp columns (not TIMESTAMP)
---

## 2026-01-14 16:45 - US-002
Thread: https://ampcode.com/threads/T-019bbd58-ab5b-74b9-a746-970d47d81810
- Created accountability_investigation_sources table in migration 013
- Includes all columns: id, investigation_id (FK with CASCADE), source_type, url, title, accessed_at, data_extracted, verification_status, created_at
- Added CHECK constraint for source_type (companies_house, charity_commission, register_of_interests, electoral_commission, contracts_finder, web_search, gov_uk, other)
- Added CHECK constraint for verification_status (verified, unverified, disputed)
- Files changed: lib/supabase/migrations/013_add_accountability_tracker_tables.sql
- **Learnings for future iterations:**
  - Pattern: Use foreign key with `ON DELETE CASCADE` for child tables referencing parent tables
---

## 2026-01-14 17:00 - US-003
Thread: https://ampcode.com/threads/T-019bbd5a-1ced-7258-9365-9716e6c1d26d
- Added 6 indexes to accountability tables in migration 013
- accountability_investigations: user_id, created_at DESC, target_entity, quality_score (partial WHERE NOT NULL)
- accountability_investigation_sources: investigation_id, source_type
- Files changed: lib/supabase/migrations/013_add_accountability_tracker_tables.sql
- **Learnings for future iterations:**
  - Pattern: Use `CREATE INDEX IF NOT EXISTS` for idempotency
  - Pattern: Use partial indexes (`WHERE column IS NOT NULL`) for nullable columns to save space
  - Pattern: Use DESC for timestamp columns commonly sorted newest-first
---

## 2026-01-14 17:15 - US-004
Thread: https://ampcode.com/threads/T-019bbd5b-bd6d-71d0-ac04-102c77d9cfcb
- Added Row Level Security policies to accountability tables
- Enabled RLS on both accountability_investigations and accountability_investigation_sources
- Users can SELECT/INSERT/UPDATE their own investigations (auth.uid() = user_id)
- Service role has full access to both tables (auth.jwt() ->> 'role' = 'service_role')
- Sources access controlled via subquery on parent investigation
- Files changed: lib/supabase/migrations/013_add_accountability_tracker_tables.sql
- **Learnings for future iterations:**
  - Pattern: Use `DROP POLICY IF EXISTS` before CREATE POLICY for idempotency
  - Pattern: Use subquery EXISTS for RLS on child tables (e.g., sources checking parent investigation ownership)
  - Pattern: Service role access uses `auth.jwt() ->> 'role' = 'service_role'`
---

## 2026-01-14 20:30 - US-005
Thread: https://ampcode.com/threads/T-019bbd5d-3f06-72eb-b72d-f2c3362fb22e
- Created /lib/types/accountability.ts with core TypeScript types
- Exported EntityType union type for individual/organization
- Exported Position, CompanyRecord, InterestDeclaration, CharityRecord, Donation, Contract interfaces
- All interfaces include required sourceUrl field for audit trail
- Files changed: lib/types/accountability.ts
- **Learnings for future iterations:**
  - Pattern: Follow existing types file conventions (see lib/types/brief.ts for examples)
  - Pattern: Use string for dates in interfaces (ISO format), number for monetary values
  - Pattern: Include sourceUrl on all record types for traceability
---
