# Ralph Progress Log
Started: Sat 10 Jan 2026 10:27:18 +04

## Codebase Patterns
- Database types are defined in lib/supabase/client.ts (not a separate types.ts file)
- Use `IF NOT EXISTS` for migrations to make them idempotent
- RLS policies: users can SELECT their own, service_role can manage all
- Credit amounts: positive = purchase/refund/bonus, negative = usage/expiry
- Supabase chained queries cause TypeScript `never` inference issues - use `(supabase as any)` for update/insert operations with helper functions
- Stripe client in lib/stripe/client.ts, use `apiVersion: '2025-12-15.clover'` for current Stripe SDK

---

## 2026-01-10 - US-001
Thread: https://ampcode.com/threads/T-019ba696-7eeb-75ea-9215-46281cbf853c
- Created migration 008_add_credits_tables.sql with 4 tables:
  - credit_packages: purchasable credit bundles
  - user_credits: per-user balance tracking
  - credit_batches: individual purchases with expiry dates
  - credit_transactions: audit log of all movements
- Added TypeScript types to Database interface in client.ts
- Fixed pre-existing type errors in app/brief/[id]/page.tsx
- **Learnings for future iterations:**
  - The prd.json and progress.txt get stashed when switching branches - be careful with git stash/checkout
  - Pre-existing type errors need to be fixed before build passes
  - Database types live in client.ts on this branch (not a separate types.ts)
---

## 2026-01-10 - US-002
Thread: https://ampcode.com/threads/T-019ba69b-c5a0-72d7-8a88-fdebe47f437f
- Created lib/services/credit-service.ts with 5 main functions:
  - getBalance(userId): Get user's credit balance
  - hasCredits(userId, amount): Check if user has enough credits
  - deductCredits(userId, amount, briefId, description): Deduct from oldest non-expired batches (FIFO)
  - addCredits(userId, amount, transactionType, stripePaymentId, expiresAt): Add credits with expiry tracking
  - refundCredits(userId, amount, briefId, reason): Refund credits for failed briefs
- All operations create transaction records for audit trail
- **Learnings for future iterations:**
  - Supabase v2 with TypeScript has `never` type inference bugs on chained queries
  - Solution: wrap update/insert in helper functions using `(supabase as any)` cast
  - Service follows pattern: getClient() returns typed client, helper functions do mutations
---

## 2026-01-10 - US-003
Thread: https://ampcode.com/threads/T-019ba6a5-59bb-741e-9999-0c321fd1256d
- Added expireOldCredits() function to expire batches past their expiry date
- Added getExpiringCreditsWarnings() to find credits expiring within 30 days
- Added sendExpiryWarningNotifications() placeholder for future notification integration
- **Learnings for future iterations:**
  - FIFO deduction was already implemented in deductCredits() from US-002
  - Batch expiry set credits_remaining to 0 and deducts from user_credits balance
  - Expiry transactions logged with type 'expiry' and negative amount
---

## 2026-01-10 - US-004
Thread: https://ampcode.com/threads/T-019ba6a7-80f8-7326-8bfb-6017e5fc0622
- Installed stripe and @stripe/stripe-js packages
- Created lib/stripe/client.ts with server-side Stripe client
- Added STRIPE_SECRET_KEY, NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY, STRIPE_WEBHOOK_SECRET to .env.example
- Created migration 009_seed_credit_packages.sql with 4 packages
- Added comprehensive Stripe setup documentation to SETUP.md
- **Learnings for future iterations:**
  - Use `apiVersion: '2025-12-15.clover'` for current Stripe SDK (API version must match installed package)
  - Also needed to install @supabase/ssr to fix pre-existing type error
---
