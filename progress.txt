# Ralph Progress Log
Started: Sat 10 Jan 2026 12:04:02 +04

## Codebase Patterns
- Reading levels use 'simple', 'standard', 'advanced' keys (not child/teen/undergrad/postdoc)
- BriefSummaries interface and ReadingLevel type are exported from lib/supabase/client.ts
- Use type assertions (as any) for Supabase tables not fully typed in schema (e.g., saved_briefs)
- Missing lib modules (auth/providers, user/useUserDisplay, paywall/usePaywall, saved-briefs/useSavedBriefs) were created as stubs

---

## 2026-01-10 - US-001
Thread: https://ampcode.com/threads/T-019ba6ef-0f7d-7539-8313-09a040d12dc8
- Updated brief summaries schema from 4 levels (child/teen/undergrad/postdoc) to 3 levels (simple/standard/advanced)
- Created BriefSummaries interface and ReadingLevel type in lib/supabase/client.ts
- Updated sample-briefs/what-is-a-state.json with new 3-level structure
- Updated sample-briefs/uk-four-day-week.json with new 3-level structure
- Updated app/brief/[id]/page.tsx reading level selector and default level
- Fixed multiple type errors in brief page (added explicit types to map callbacks)
- Created missing modules: lib/auth/providers.ts, lib/supabase/browser.ts, lib/user/useUserDisplay.ts, lib/paywall/usePaywall.ts, lib/saved-briefs/useSavedBriefs.ts
- Added saved_briefs table to Database type
- **Files changed:**
  - lib/supabase/client.ts
  - lib/supabase/browser.ts (new)
  - lib/auth/providers.ts (new)
  - lib/user/useUserDisplay.ts (new)
  - lib/paywall/usePaywall.ts (new)
  - lib/saved-briefs/useSavedBriefs.ts (new)
  - app/brief/[id]/page.tsx
  - sample-briefs/what-is-a-state.json
  - sample-briefs/uk-four-day-week.json
- **Learnings for future iterations:**
  - Several auth/user modules were missing stubs - these need to be properly implemented later
  - When working on briefs, remember summaries use simple/standard/advanced keys
  - Supabase typed client requires table definitions in Database interface
---

## 2026-01-10 - US-002
Thread: https://ampcode.com/threads/T-019ba6fa-97ea-7793-be2e-356d1eb17279
- Created reusable ReadingLevelSelector component
- Component displays 3 pill buttons: Simple, Standard, Advanced
- Accepts level prop and onLevelChange callback
- Selected level uses filled styling, unselected uses outline
- Typecheck passes, verified in browser
- **Files changed:**
  - app/components/ReadingLevelSelector.tsx (new)
- **Learnings for future iterations:**
  - Brief page already has inline reading level selector - US-003 will replace it with this reusable component
  - Component uses ReadingLevel type from lib/supabase/client.ts for type safety
---

## 2026-01-10 - US-003
Thread: https://ampcode.com/threads/T-019ba702-4e2c-705d-9782-5b9ef959f02b
- Integrated ReadingLevelSelector component into brief page
- Added URL query param persistence using useSearchParams and useRouter
- Added localStorage persistence for return visits (key: soc_reading_level)
- URL syncs on initial load from localStorage if no URL param present
- Removed inline reading level selector code (replaced with component)
- **Files changed:**
  - app/brief/[id]/page.tsx
- **Learnings for future iterations:**
  - Use router.replace with { scroll: false } to update URL without page reload
  - localStorage key uses 'soc_' prefix for State of Clarity namespace
  - isValidReadingLevel type guard ensures type safety when reading from URL/localStorage
---

## 2026-01-10 - US-004
Thread: https://ampcode.com/threads/T-019ba705-971e-778d-83e9-3d0c6cae1f59
- Added summary section that reads from brief.summaries[activeLevel]
- Implemented 200ms fade transition using animate-fade-in class with key={activeLevel}
- Added max-width: 65ch inline style for readable line length
- Added leading-relaxed class for readable line height
- Added fade-in keyframes and animation to tailwind.config.ts
- **Files changed:**
  - app/brief/[id]/page.tsx
  - tailwind.config.ts
- **Learnings for future iterations:**
  - Tailwind arbitrary values like max-w-[65ch] may not work in all contexts; use inline style as fallback
  - Use key={value} on elements to trigger re-mounting for CSS animations
  - The animate-fade-in class triggers when component key changes
---

## 2026-01-10 - US-005
Thread: https://ampcode.com/threads/T-019ba70c-8039-7438-9205-dc5b6c579d03
- Created reusable CollapsibleSection component at app/components/CollapsibleSection.tsx
- Props: title, itemCount (optional), defaultExpanded (defaults false), children
- Header displays title with optional item count in parentheses (e.g., "Factors (12)")
- Chevron icon rotates 180Â° on expand/collapse with transition-transform duration-200
- Smooth 200ms height animation using ResizeObserver and scrollHeight
- Verified in browser: expand/collapse toggles work correctly
- **Files changed:**
  - app/components/CollapsibleSection.tsx (new)
- **Learnings for future iterations:**
  - Use ResizeObserver to track content height for dynamic children
  - For height animations, set height explicitly via style with transition, not Tailwind class
  - Use aria-expanded for accessibility on collapsible buttons
---

## 2026-01-10 - US-006
Thread: https://ampcode.com/threads/T-019ba710-429b-7358-921b-445361ab8409
- Created StructuredDataSections component at app/components/StructuredDataSections.tsx
- Component displays 5 CollapsibleSections: Definitions, Historical Summary, Factors, Policy Suggestions, Consequences
- Smart defaults: Definitions and Factors expanded, others collapsed
- Each section renders appropriate table with proper formatting
- Tables have horizontal scroll on mobile (min-width with overflow-x: auto)
- Replaced inline structured data sections in brief page with the new component
- Modified CollapsibleSection to allow horizontal scrolling (removed overflow-hidden from container)
- **Files changed:**
  - app/components/StructuredDataSections.tsx (new)
  - app/components/CollapsibleSection.tsx (modified for overflow)
  - app/brief/[id]/page.tsx (integrated StructuredDataSections)
- **Learnings for future iterations:**
  - CollapsibleSection's overflow-hidden on container blocks child horizontal scrolling; use overflowY: hidden, overflowX: auto on the content div instead
  - For mobile-responsive tables, use min-width on table element with overflow-x: auto wrapper
  - Historical summary is optional - component conditionally renders it when present in data
---

## 2026-01-10 - US-007
Thread: https://ampcode.com/threads/T-019ba71d-40f4-70aa-a78c-31934b3e5295
- Created CitationTooltip component at app/components/CitationTooltip.tsx
- Component displays source title, publisher, date, political lean badge, and credibility score
- Political lean uses color coding: left=blue, center=gray, right=red (with gradients for center-left, center-right)
- Tooltip appears on hover with 100ms delay using setTimeout
- Smart positioning: adjusts to show above or below based on viewport space
- Also fixed StructuredDataSections.tsx to handle both policy formats (pros/cons and detail/justification/case_studies)
- **Files changed:**
  - app/components/CitationTooltip.tsx (new)
  - app/components/StructuredDataSections.tsx (updated Policy interface and rendering)
- **Learnings for future iterations:**
  - Sample briefs have different policy data formats - some have pros/cons, others have detail/justification/case_studies
  - Use optional chaining (policy.pros?.map) when data fields might be undefined
  - For tooltip positioning, use getBoundingClientRect() and window.innerHeight to calculate available space
---

## 2026-01-10 - US-008
Thread: https://ampcode.com/threads/T-019ba728-8716-7321-9cf4-561a7aac094a
- Created NarrativeSection component at app/components/NarrativeSection.tsx
- Component parses narrative text for [n] citation markers using regex
- Renders citations as superscript numbers wrapped in CitationTooltip component
- Clicking a citation scrolls to the corresponding source (using source-N id)
- Added highlight flash effect (2s ring animation) when scrolling to source
- Set max-width 65ch on narrative container for comfortable reading width
- Added id attributes to source elements in brief page for scroll linking
- Integrated NarrativeSection into brief page, replacing inline narrative rendering
- **Files changed:**
  - app/components/NarrativeSection.tsx (new)
  - app/brief/[id]/page.tsx (integrated NarrativeSection, added source ids)
- **Learnings for future iterations:**
  - Sample briefs don't currently have [n] markers in narrative - feature is ready for when they do
  - Use prose class without max-w-none when wanting to apply custom max-width
  - Source ids follow pattern source-{index+1} matching citation numbers
---

## 2026-01-10 - US-009
Thread: https://ampcode.com/threads/T-019ba72e-7762-77a1-9112-8f77e8d150b3
- Created SourcesSection component at app/components/SourcesSection.tsx
- Component displays all sources numbered (1, 2, 3...) matching inline citation numbers
- Each source shows: title with external link, author, publisher, date
- Added type badge (primary/secondary) and political lean badge with color coding
- Added credibility score with horizontal progress bar
- Excerpt with truncation at 200 chars and "Show more" toggle
- Section header shows source count (e.g., "Sources (15)")
- Each source has id attribute (source-{n}) for scroll-to-citation linking
- Integrated into brief page after Structured Data section
- **Files changed:**
  - app/components/SourcesSection.tsx (new)
  - app/brief/[id]/page.tsx (integrated SourcesSection)
- **Learnings for future iterations:**
  - Source interface includes: id, url, title, author, publication_date, publisher, source_type, political_lean, credibility_score, excerpt
  - Political lean color coding: left=blue, center-left=sky, center=gray, center-right=orange, right=red
  - Source type badges: primary=purple, secondary=indigo
---
