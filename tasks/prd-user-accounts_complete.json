{
  "project": "State of Clarity",
  "branchName": "ralph/user-accounts",
  "description": "Full user account system with email/password, magic link, social logins (Google, Apple, X), personalization data, anonymous posting, soft paywall (3 free briefs), and 30-day soft delete",
  "userStories": [
    {
      "id": "US-001",
      "title": "Configure Supabase auth providers",
      "description": "As a developer, I need to configure all authentication providers in Supabase.",
      "acceptanceCriteria": [
        "Enable email/password authentication in Supabase config",
        "Enable magic link (passwordless) authentication",
        "Configure Google OAuth provider placeholder (credentials added manually)",
        "Configure Apple OAuth provider placeholder",
        "Configure X/Twitter OAuth provider placeholder",
        "Document provider setup steps in SETUP.md",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Extend user profiles table",
      "description": "As a developer, I need to store full personalization data for users.",
      "acceptanceCriteria": [
        "Add columns to profiles table: display_name, avatar_url, preferred_reading_level, topics_of_interest (JSONB), notification_preferences (JSONB), anonymous_posting (boolean default false)",
        "Add reading_history table: id, user_id, brief_id, reading_level_viewed, read_at, time_spent_seconds",
        "Add question_history table: id, user_id, question, brief_id, asked_at",
        "Add deleted_at and deletion_scheduled_at columns to profiles for soft delete",
        "Create migration /lib/supabase/migrations/007_extend_user_profiles.sql",
        "Update Database interface in client.ts with all new types",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Create auth modal component",
      "description": "As a user, I want a clean login/signup interface with multiple auth options.",
      "acceptanceCriteria": [
        "Create /app/components/auth/AuthModal.tsx",
        "Display email input with 'Continue with email' button",
        "Show social login buttons: Google, Apple, X with icons",
        "Toggle between sign up and sign in modes",
        "Handle loading and error states with appropriate messages",
        "Modal can be triggered from anywhere in the app",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Implement email/password authentication",
      "description": "As a user, I want to sign up and log in with email and password.",
      "acceptanceCriteria": [
        "Create /app/components/auth/EmailPasswordForm.tsx",
        "Validate email format and password strength (min 8 chars)",
        "Handle sign up flow with Supabase auth.signUp",
        "Handle sign in flow with Supabase auth.signInWithPassword",
        "Show appropriate error messages for invalid credentials",
        "Show 'Forgot password' link that triggers password reset email",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Implement magic link authentication",
      "description": "As a user, I want to log in without a password using a magic link.",
      "acceptanceCriteria": [
        "Add 'Send magic link' option in auth modal after email entry",
        "Send magic link email via Supabase auth.signInWithOtp",
        "Handle magic link callback in /app/auth/callback/route.ts",
        "Create or update user profile on first magic link login",
        "Show 'Check your email' confirmation message after sending",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Implement social login buttons",
      "description": "As a user, I want to log in with Google, Apple, or X.",
      "acceptanceCriteria": [
        "Create /app/components/auth/SocialLoginButtons.tsx",
        "Implement Google OAuth flow via Supabase auth.signInWithOAuth",
        "Implement Apple OAuth flow via Supabase auth.signInWithOAuth",
        "Implement X/Twitter OAuth flow via Supabase auth.signInWithOAuth",
        "Handle OAuth callback and session creation",
        "Create or update user profile on first social login with name/avatar from provider",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Create user profile settings page",
      "description": "As a user, I want to manage my profile and preferences.",
      "acceptanceCriteria": [
        "Create /app/settings/page.tsx with protected route",
        "Display and edit: display name, avatar upload",
        "Select preferred reading level dropdown (child/teen/undergrad/postdoc)",
        "Select topics of interest multi-select from domain list",
        "Toggle anonymous posting preference",
        "Toggle notification preferences",
        "Save changes to database on submit",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Implement brief preview for anonymous users",
      "description": "As an anonymous visitor, I want to preview the first 20% of a brief before signing up.",
      "acceptanceCriteria": [
        "Create /app/components/BriefPreview.tsx",
        "Calculate 20% of narrative content word count",
        "Show first 20% of narrative with gradient fade overlay on rest",
        "Show 'Sign up to read full brief' call-to-action button",
        "Track preview views count in localStorage under 'soc_preview_count'",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Implement soft paywall after 3 briefs",
      "description": "As a system, I need to enforce account creation after 3 brief previews.",
      "acceptanceCriteria": [
        "Track brief view count in localStorage 'soc_free_briefs_used'",
        "Allow 3 full brief reads for anonymous users",
        "On 4th brief, show only 20% preview with signup wall",
        "Show 'X free briefs remaining' message to anonymous users",
        "Clear localStorage counts on successful signup",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Implement anonymous posting mode",
      "description": "As a user, I want to post comments/feedback anonymously while still being tracked for payment.",
      "acceptanceCriteria": [
        "Read anonymous_posting preference from user profile",
        "When enabled, display 'Anonymous User' instead of name on public feedback",
        "Still store user_id in database for tracking and payment",
        "Show current mode in profile settings with toggle",
        "Apply to existing feedback submission forms",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Create saved briefs functionality",
      "description": "As a user, I want to save briefs to read later.",
      "acceptanceCriteria": [
        "Add save/bookmark button to brief view page",
        "Toggle save state in saved_briefs table on click",
        "Create /app/saved/page.tsx to list all saved briefs",
        "Show saved count badge in user menu",
        "Allow removing briefs from saved list",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 11,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Track reading history",
      "description": "As a system, I need to track what users read for personalization.",
      "acceptanceCriteria": [
        "Log brief view to reading_history when authenticated user opens full brief",
        "Track which reading level they viewed",
        "Track approximate time spent using Page Visibility API",
        "Create /app/history/page.tsx to show user's reading history",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 12,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Track question history",
      "description": "As a system, I need to track questions users ask.",
      "acceptanceCriteria": [
        "Log question to question_history when user generates a brief",
        "Link to resulting brief_id if generation succeeds",
        "Show recent questions section on user dashboard or history page",
        "Allow clicking to re-ask previous questions",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Implement soft delete for accounts",
      "description": "As a user, I want to delete my account with a 30-day recovery window.",
      "acceptanceCriteria": [
        "Create /app/settings/delete-account/page.tsx",
        "Show warning about 30-day recovery period and what will be deleted",
        "On confirm, set deletion_scheduled_at to now + 30 days",
        "Set deleted_at to now to mark account as deleted",
        "Disable account access by checking deleted_at on auth",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 14,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Create account recovery flow",
      "description": "As a user who deleted my account, I want to recover it within 30 days.",
      "acceptanceCriteria": [
        "Detect deleted account (deleted_at not null) on login attempt",
        "Show 'Your account is scheduled for deletion on X date' message",
        "Provide 'Restore my account' button",
        "On restore: clear deleted_at and deletion_scheduled_at",
        "Re-enable full account access immediately",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 15,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Add user menu to navigation",
      "description": "As a user, I want easy access to my account from the navigation.",
      "acceptanceCriteria": [
        "Create /app/components/UserMenu.tsx",
        "Show avatar and display name when logged in",
        "Dropdown menu with: Settings, Saved Briefs, History, Sign Out",
        "Show 'Sign In' button when logged out",
        "Show credit balance placeholder (for Theme 6)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 16,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Test authentication flows",
      "description": "As a developer, I need to validate all auth flows work correctly.",
      "acceptanceCriteria": [
        "Create test-auth.ts script with manual testing checklist",
        "Document test steps for: email/password signup and login",
        "Document test steps for: magic link flow",
        "Document test steps for: profile update and preferences",
        "Document test steps for: account deletion and recovery",
        "Print checklist to console for manual verification",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    }
  ]
}
